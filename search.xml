<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å¾®å‰ç«¯ï¼ˆqiankunï¼‰å°é²œ(vue)</title>
      <link href="/2021/06/17/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%88qiankun%EF%BC%89%E5%B0%9D%E9%B2%9C/"/>
      <url>/2021/06/17/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%88qiankun%EF%BC%89%E5%B0%9D%E9%B2%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼Ÿ</h2><blockquote><p>Techniques, strategies and recipes for building a modern web app with multiple teams that can ship features independently. â€“ <a href="https://micro-frontends.org/" target="_blank" rel="noopener">Micro Frontends</a></p><p>å¾®å‰ç«¯æ˜¯ä¸€ç§å¤šä¸ªå›¢é˜Ÿé€šè¿‡ç‹¬ç«‹å‘å¸ƒåŠŸèƒ½çš„æ–¹å¼æ¥å…±åŒæ„å»ºç°ä»£åŒ– web åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µåŠæ–¹æ³•ç­–ç•¥ã€‚</p></blockquote><p>å¾®å‰ç«¯ï¼ˆMicro-Frontendsï¼‰æ˜¯ä¸€ç§ç±»ä¼¼äºå¾®æœåŠ¡çš„æ¶æ„ï¼Œå®ƒå°†å¾®æœåŠ¡çš„ç†å¿µåº”ç”¨äºæµè§ˆå™¨ç«¯ï¼Œå³å°† Web åº”ç”¨ç”±å•ä¸€çš„å•ä½“åº”ç”¨è½¬å˜ä¸ºå¤šä¸ªå°å‹å‰ç«¯åº”ç”¨èšåˆä¸ºä¸€çš„åº”ç”¨ã€‚å„ä¸ªå‰ç«¯åº”ç”¨è¿˜å¯ä»¥ç‹¬ç«‹è¿è¡Œã€ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²ï¼Œä»è€Œæ»¡è¶³ä¸šåŠ¡å¿«é€Ÿå˜åŒ–åŠåˆ†å¸ƒå¼å¤šå›¢é˜Ÿå¹¶è¡Œå¼€å‘çš„éœ€æ±‚ã€‚<br>å¾®å‰ç«¯ä¸æ˜¯å•çº¯çš„å‰ç«¯æ¡†æ¶æˆ–è€…å·¥å…·ï¼Œè€Œæ˜¯ä¸€å¥—æ¶æ„ä½“ç³»ï¼Œè¿™ä¸ªæ¦‚å¿µæœ€æ—©åœ¨2016å¹´åº•ç”±ThoughtWorksæå‡ºã€‚</p><h2 id="æ ¸å¿ƒä»·å€¼"><a href="#æ ¸å¿ƒä»·å€¼" class="headerlink" title="æ ¸å¿ƒä»·å€¼"></a>æ ¸å¿ƒä»·å€¼</h2><ul><li><p><strong>æŠ€æœ¯æ ˆæ— å…³</strong></p><p>ä¸»åº”ç”¨ä¸é™åˆ¶æ¥å…¥å­åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå­åº”ç”¨æ‹¥æœ‰å®Œå…¨è‡ªä¸»æƒã€‚åº”ç”¨ä¹‹é—´ä¸åº”è¯¥æœ‰ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„æŠ€æœ¯æ ˆã€ä¾èµ–ã€ä»¥åŠå®ç°ä¸Šçš„è€¦åˆã€‚</p></li><li><p>ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²</p><p>å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°ã€‚ç‹¬ç«‹éƒ¨ç½²çš„èƒ½åŠ›åœ¨å¾®å‰ç«¯ä½“ç³»ä¸­è‡³å…³é‡è¦ï¼Œèƒ½å¤Ÿç¼©å°å˜æ›´èŒƒå›´ï¼Œè¿›è€Œé™ä½ç›¸å…³é£é™©ã€‚<br>å„ä¸ªå¾®å‰ç«¯éƒ½åº”è¯¥æœ‰è‡ªå·±çš„æŒç»­äº¤ä»˜ç®¡é“ï¼›è¿™äº›ç®¡é“å¯ä»¥å°†å¾®å‰ç«¯æ„å»ºã€æµ‹è¯•å¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚</p></li><li><p>å¢é‡å‡çº§</p><p>åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥ã€‚<br>é€æ¸å‡çº§æˆ‘ä»¬çš„æ¶æ„ã€ä¾èµ–å…³ç³»å’Œç”¨æˆ·ä½“éªŒã€‚å½“ä¸»æ¡†æ¶å‘ç”Ÿé‡å¤§å˜åŒ–æ—¶æ¯ä¸ªå¾®å‰ç«¯æ¨¡å—éƒ½å¯ä»¥æŒ‰éœ€å‡çº§ï¼Œä¸éœ€è¦æ•´ä½“ä¸‹çº¿æˆ–ä¸€æ¬¡æ€§å‡çº§æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å°è¯•æ–°çš„æŠ€æœ¯æˆ–äº’åŠ¨æ¨¡å¼ï¼Œä¹Ÿèƒ½åœ¨éš”ç¦»åº¦æ›´å¥½çš„ç¯å¢ƒä¸‹åšè¯•éªŒã€‚</p></li><li><p>ç®€å•ã€è§£è€¦ã€æ˜“ç»´æŠ¤</p><p>å¾®å‰ç«¯æ¶æ„ä¸‹çš„ä»£ç åº“å€¾å‘äºæ›´å°/ç®€å•ã€æ›´å®¹æ˜“å¼€å‘ï¼Œé¿å…æ— å…³ç»„ä»¶ä¹‹é—´ä¸å¿…è¦çš„è€¦åˆï¼Œè®©ä»£ç æ›´ç®€æ´ã€‚é€šè¿‡ç•Œå®šæ¸…æ™°çš„åº”ç”¨è¾¹ç•Œæ¥é™ä½æ„å¤–è€¦åˆçš„å¯èƒ½æ€§ï¼Œæ›´å¥½åœ°é¿å…æ— æ„é—´é€ æˆçš„è¿™ç±»è€¦åˆé—®é¢˜ã€‚</p></li></ul><p>æ›´å¤šå‚è€ƒæ–‡çŒ®ï¼š</p><ul><li><a href="https://micro-frontends.org/" target="_blank" rel="noopener">Micro Frontends</a></li><li><a href="https://martinfowler.com/articles/micro-frontends.html" target="_blank" rel="noopener">Micro Frontends from martinfowler.com</a></li><li><a href="https://zhuanlan.zhihu.com/p/95085796" target="_blank" rel="noopener">å¾®å‰ç«¯çš„æ ¸å¿ƒä»·å€¼</a></li></ul><h2 id="åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ"><a href="#åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ" class="headerlink" title="åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ"></a>åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ</h2><blockquote><p>å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„æ—¶é—´è·¨åº¦ä¸‹ï¼Œç”±äºå‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿ï¼Œä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ªå·¨çŸ³åº”ç”¨(Frontend Monolith)åï¼Œéšä¹‹è€Œæ¥çš„åº”ç”¨ä¸å¯ç»´æŠ¤çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚</p><ul><li>å…¼å®¹é—ç•™ç³»ç»Ÿ</li></ul></blockquote><p>  åœ¨ç°åœ¨æŠ€æœ¯ä¸æ–­æ›´è¿­ï¼Œä¿è¯æŠ€æœ¯æ ˆä¸è½åï¼Œéœ€è¦åœ¨å…¼å®¹å·²æœ‰ç³»ç»Ÿçš„å‰æä¸‹ï¼Œä½¿ç”¨æ–°æ¡†æ¶å»å¼€å‘æ–°åŠŸèƒ½ã€‚é—ç•™ç³»ç»ŸåŠŸèƒ½å·²ç»å®Œå–„ï¼Œå¹¶ä¸”ç¨³å®šè¿è¡Œï¼Œå›¢é˜Ÿæ²¡æœ‰å¿…è¦ï¼Œä¹Ÿæ²¡æœ‰ç²¾åŠ›å»å°†é—ç•™ç³»ç»Ÿé‡æ„ä¸€éã€‚æ­¤æ—¶å›¢é˜Ÿå¦‚æœéœ€è¦ä½¿ç”¨æ–°æ¡†æ¶ï¼Œæ–°æŠ€æœ¯å»å¼€å‘æ–°çš„åº”ç”¨ï¼Œä½¿ç”¨å¾®å‰ç«¯æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p><ul><li><p>åº”ç”¨èšåˆ</p><p>å¤§å‹çš„äº’è”ç½‘å…¬å¸ï¼Œæˆ–å•†ä¸šSaaså¹³å°ï¼Œéƒ½ä¼šä¸ºç”¨æˆ·/å®¢æˆ·æä¾›å¾ˆå¤šåº”ç”¨å’ŒæœåŠ¡ï¼Œå¦‚ä½•ä¸ºç”¨æˆ·å‘ˆç°å…·æœ‰ç»Ÿä¸€ç”¨æˆ·ä½“éªŒå’Œä¸€ç«™å¼çš„åº”ç”¨èšåˆæˆä¸ºå¿…é¡»è§£å†³çš„é—®é¢˜ã€‚<br>å‰ç«¯èšåˆå·²æˆä¸ºä¸€ä¸ªæŠ€æœ¯è¶‹åŠ¿ï¼Œç›®å‰æ¯”è¾ƒç†æƒ³çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å¾®å‰ç«¯ã€‚</p></li><li><p>ä¸åŒå›¢é˜Ÿé—´å¼€å‘åŒä¸€ä¸ªåº”ç”¨æŠ€æœ¯æ ˆä¸åŒ</p><p>æŠŠç¬¬ä¸‰æ–¹çš„SaaSåº”ç”¨è¿›è¡Œé›†æˆæˆ–è€…æŠŠç¬¬ä¸‰æ–¹ç§æœåº”ç”¨è¿›è¡Œé›†æˆï¼ˆæ¯”å¦‚åœ¨å…¬å¸å†…éƒ¨éƒ¨ç½²çš„ gitlabï¼‰ç­‰ã€‚ä»¥åŠåœ¨å·²æœ‰å¤šä¸ªåº”ç”¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å°†å®ƒä»¬èšåˆä¸ºä¸€ä¸ªå•åº”ç”¨ã€‚<br><img src="/images/micro.png" alt></p></li></ul><h2 id="ä»€ä¹ˆæ˜¯qiankunï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯qiankunï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯qiankunï¼Ÿ"></a>ä»€ä¹ˆæ˜¯qiankunï¼Ÿ</h2><p>qiankun æ˜¯ä¸€ä¸ªåŸºäº <a href="https://github.com/CanopyTax/single-spa" target="_blank" rel="noopener">single-spa</a> çš„<a href="https://micro-frontends.org/" target="_blank" rel="noopener">å¾®å‰ç«¯</a>å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚</p><p>qiankun å­µåŒ–è‡ªèš‚èšé‡‘èç§‘æŠ€åŸºäºå¾®å‰ç«¯æ¶æ„çš„äº‘äº§å“ç»Ÿä¸€æ¥å…¥å¹³å°ï¼Œåœ¨ç»è¿‡ä¸€æ‰¹çº¿ä¸Šåº”ç”¨çš„å……åˆ†æ£€éªŒåŠæ‰“ç£¨åï¼Œæˆ‘ä»¬å°†å…¶å¾®å‰ç«¯å†…æ ¸æŠ½å–å‡ºæ¥å¹¶å¼€æºï¼Œå¸Œæœ›èƒ½åŒæ—¶å¸®åŠ©ç¤¾åŒºæœ‰ç±»ä¼¼éœ€æ±‚çš„ç³»ç»Ÿæ›´æ–¹ä¾¿çš„æ„å»ºè‡ªå·±çš„å¾®å‰ç«¯ç³»ç»Ÿï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›é€šè¿‡ç¤¾åŒºçš„å¸®åŠ©å°† qiankun æ‰“ç£¨çš„æ›´åŠ æˆç†Ÿå®Œå–„ã€‚</p><p>ç›®å‰ qiankun å·²åœ¨èš‚èšå†…éƒ¨æœåŠ¡äº†è¶…è¿‡ 200+ çº¿ä¸Šåº”ç”¨ï¼Œåœ¨æ˜“ç”¨æ€§åŠå®Œå¤‡æ€§ä¸Šï¼Œç»å¯¹æ˜¯å€¼å¾—ä¿¡èµ–çš„ã€‚</p><ul><li>ğŸ“¦ <strong>åŸºäº <a href="https://github.com/CanopyTax/single-spa" target="_blank" rel="noopener">single-spa</a></strong> å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚</li><li>ğŸ“± <strong>æŠ€æœ¯æ ˆæ— å…³</strong>ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥ï¼Œä¸è®ºæ˜¯ React/Vue/Angular/JQuery è¿˜æ˜¯å…¶ä»–ç­‰æ¡†æ¶ã€‚</li><li>ğŸ’ª <strong>HTML Entry æ¥å…¥æ–¹å¼</strong>ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚</li><li>ğŸ›¡â€‹ <strong>æ ·å¼éš”ç¦»</strong>ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚</li><li>ğŸ§³ <strong>JS æ²™ç®±</strong>ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚</li><li>âš¡ï¸ <strong>èµ„æºé¢„åŠ è½½</strong>ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚</li><li>ğŸ”Œ <strong>umi æ’ä»¶</strong>ï¼Œæä¾›äº† <a href="https://github.com/umijs/plugins/tree/master/packages/plugin-qiankun" target="_blank" rel="noopener">@umijs/plugin-qiankun</a> ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚<blockquote><p>æ‘˜è‡ªqiankunä»‹ç»</p></blockquote><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><h3 id="å­åº”ç”¨é™æ€èµ„æº404"><a href="#å­åº”ç”¨é™æ€èµ„æº404" class="headerlink" title="å­åº”ç”¨é™æ€èµ„æº404"></a>å­åº”ç”¨é™æ€èµ„æº404</h3></li></ul><ol><li>æ‰€æœ‰å›¾ç‰‡ç­‰é™æ€èµ„æºä¸Šä¼ è‡³ cdnï¼Œcss ä¸­ç›´æ¥å¼•ç”¨ cdn åœ°å€ï¼ˆæ¨èï¼‰</li><li><p>å°†å­—ä½“æ–‡ä»¶å’Œå›¾ç‰‡æ‰“åŒ…æˆ base64ï¼ˆé€‚ç”¨äºå­—ä½“æ–‡ä»¶å’Œå›¾ç‰‡ä½“ç§¯å°çš„é¡¹ç›®ï¼‰(ä½†æ€»æ˜¯æœ‰ä¸€äº›ä¸ç¬¦åˆè¦æ±‚çš„èµ„æºï¼Œè¯·ä½¿ç”¨ç¬¬ä¸‰ç§)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack config loader, æ·»åŠ ä»¥ä¸‹ruleåˆ°rulesä¸­</span></span><br><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(png|jpe?g|gif|webp|woff2?|eot|ttf|otf)$/i</span>,</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">'url-loader'</span>,</span><br><span class="line">    options: &#123;&#125;,</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// chainWebpack</span></span><br><span class="line">config.module.rule(<span class="string">'fonts'</span>).use(<span class="string">'url-loader'</span>).loader(<span class="string">'url-loader'</span>).options(&#123;&#125;).end();</span><br><span class="line">config.module.rule(<span class="string">'images'</span>).use(<span class="string">'url-loader'</span>).loader(<span class="string">'url-loader'</span>).options(&#123;&#125;).end();</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ‰“åŒ…æ—¶ç»™å…¶æ³¨å…¥å®Œæ•´è·¯å¾„ï¼ˆé€‚ç”¨äºå­—ä½“æ–‡ä»¶å’Œå›¾ç‰‡ä½“ç§¯æ¯”è¾ƒå¤§çš„é¡¹ç›®ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> absolutePath = <span class="string">'å­åº”ç”¨ä¸‡ç»´ç½‘å¯è®¿é—®url'</span>;</span><br><span class="line"><span class="keyword">const</span> publicPath = <span class="string">`<span class="subst">$&#123;absolutePath&#125;</span><span class="subst">$&#123;config.output.get(<span class="string">'publicPath'</span>)&#125;</span>`</span>;</span><br><span class="line">    config.module</span><br><span class="line">      .rule(<span class="string">'fonts'</span>)</span><br><span class="line">      .use(<span class="string">'url-loader'</span>)</span><br><span class="line">      .loader(<span class="string">'url-loader'</span>)</span><br><span class="line">      .options(&#123;</span><br><span class="line">        limit: <span class="number">4096</span>, <span class="comment">// å°äº4kbå°†ä¼šè¢«æ‰“åŒ…æˆ base64</span></span><br><span class="line">        fallback: &#123;</span><br><span class="line">          loader: <span class="string">'file-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            name: <span class="string">'fonts/[name].[hash:8].[ext]'</span>,</span><br><span class="line">            publicPath</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .end();</span><br><span class="line">    config.module</span><br><span class="line">      .rule(<span class="string">'images'</span>)</span><br><span class="line">      .use(<span class="string">'url-loader'</span>)</span><br><span class="line">      .loader(<span class="string">'url-loader'</span>)</span><br><span class="line">      .options(&#123;</span><br><span class="line">        limit: <span class="number">4096</span>, <span class="comment">// å°äº4kbå°†ä¼šè¢«æ‰“åŒ…æˆ base64</span></span><br><span class="line">        fallback: &#123;</span><br><span class="line">          loader: <span class="string">'file-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            name: <span class="string">'img/[name].[hash:8].[ext]'</span>,</span><br><span class="line">            publicPath</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure></li></ol><h3 id="cssæ ·å¼éš”ç¦»"><a href="#cssæ ·å¼éš”ç¦»" class="headerlink" title="cssæ ·å¼éš”ç¦»"></a>cssæ ·å¼éš”ç¦»</h3><p>é»˜è®¤æƒ…å†µqiankunä¼šè‡ªåŠ¨å¼€å¯æ²™ç®±æ¨¡å¼ï¼Œä½†è¿™ä¸ªæ¨¡å¼æ— æ³•éš”ç¦»ä¸»åº”ç”¨ä¸å­åº”ç”¨ã€æˆ–è€…åŒæ—¶åŠ è½½å¤šå­åº”ç”¨çš„åœºæ™¯ã€‚<br>qiankunè¿˜ç»™å‡ºäº†shadow domçš„æ–¹æ¡ˆï¼Œéœ€è¦é…ç½®<code>sandbox: { strictStyleIsolation: true }</code></p><blockquote><p>åŸºäº ShadowDOM çš„ä¸¥æ ¼æ ·å¼éš”ç¦»å¹¶ä¸æ˜¯ä¸€ä¸ªå¯ä»¥æ— è„‘ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½éœ€è¦æ¥å…¥åº”ç”¨åšä¸€äº›é€‚é…åæ‰èƒ½æ­£å¸¸åœ¨ ShadowDOM ä¸­è¿è¡Œèµ·æ¥æ¯”å¦‚ react åœºæ™¯ä¸‹éœ€è¦è§£å†³è¿™äº›<a href="https://github.com/facebook/react/issues/10422" target="_blank" rel="noopener">é—®é¢˜</a> ï¼Œä½¿ç”¨è€…éœ€è¦æ¸…æ¥šå¼€å¯äº† strictStyleIsolation æ„å‘³ç€ä»€ä¹ˆã€‚ä¸‹é¢ä¼šåˆ—å‡ºæˆ‘è§£å†³ShadowDomçš„ä¸€äº›æ¡ˆä¾‹ã€‚</p></blockquote><h3 id="js-æ²™ç®±"><a href="#js-æ²™ç®±" class="headerlink" title="js æ²™ç®±"></a>js æ²™ç®±</h3><p>ä¸»è¦æ˜¯éš”ç¦»æŒ‚è½½åœ¨<code>window</code>ä¸Šçš„å˜é‡ï¼Œè€Œqiankunå†…éƒ¨å·²ç»å¸®ä½ å¤„ç†å¥½äº†ã€‚åœ¨å­åº”ç”¨è¿è¡Œæ—¶è®¿é—®çš„<code>window</code>å…¶å®æ˜¯ä¸€ä¸ª<code>Proxy</code>ä»£ç†å¯¹è±¡ã€‚<br>æ‰€æœ‰å­åº”ç”¨çš„å…¨å±€å˜é‡å˜æ›´éƒ½æ˜¯åœ¨é—­åŒ…ä¸­äº§ç”Ÿçš„ï¼Œä¸ä¼šçœŸæ­£å›å†™åˆ° window ä¸Šï¼Œè¿™æ ·å°±èƒ½é¿å…å¤šå®ä¾‹ä¹‹é—´çš„æ±¡æŸ“äº†ã€‚<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy93Uk5sV0tuMEE1TXdpYWo4MmtYdmNCN09HaWFlVGljMkdOcjZEMEMxTFQ1Wmg0aWFpY2VpYVJRSVVSWk5sb01pYU8wVkQyNXQyUjdKR3JkNDNvOWY5ZHNOZTQwancvNjQw?x-oss-process=image/format,png" alt><br>`</p><h3 id="fix-shadow-dom"><a href="#fix-shadow-dom" class="headerlink" title="fix shadow dom"></a>fix shadow dom</h3><ul><li><p>getComputedStyle</p><p>å½“è·å–shadow domçš„è®¡ç®—æ ·å¼çš„æ—¶å€™ä¼ å…¥çš„elementæ˜¯<code>DocumentFragment</code>,ä¼šæŠ¥é”™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getComputedStyle = <span class="built_in">window</span>.getComputedStyle;</span><br><span class="line"><span class="built_in">window</span>.getComputedStyle = <span class="function">(<span class="params">el, ...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœä¸ºshadow domåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (el <span class="keyword">instanceof</span> DocumentFragment) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Reflect</span>.apply(getComputedStyle, <span class="built_in">window</span>, [el, ...args]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>elementFromPoint</p><p>æ ¹æ®åæ ‡ï¼ˆx, yï¼‰å½“è·å–ä¸€ä¸ªå­åº”ç”¨çš„å…ƒç´ çš„æ—¶å€™ï¼Œä¼šè¿”å›shadow rootï¼Œå¹¶ä¸ä¼šè¿”å›çœŸæ­£çš„å…ƒç´ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementFromPoint = <span class="built_in">document</span>.elementFromPoint;</span><br><span class="line"><span class="built_in">document</span>.elementFromPoint = <span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.apply(elementFromPoint, <span class="keyword">this</span>, [x, y]);</span><br><span class="line">  <span class="comment">// å¦‚æœåæ ‡å…ƒç´ ä¸ºshadowåˆ™ç”¨è¯¥shadowå†æ¬¡è·å–</span></span><br><span class="line">  <span class="keyword">if</span> (result &amp;&amp; result.shadowRoot) &#123;</span><br><span class="line">    <span class="keyword">return</span> result.shadowRoot.elementFromPoint(x, y);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>document äº‹ä»¶ target ä¸ºshadow</p><p>å½“æˆ‘ä»¬åœ¨documentæ·»åŠ clickã€mousedownã€mouseupç­‰äº‹ä»¶çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°ä¸­çš„<code>event.target</code>ä¸æ˜¯çœŸæ­£çš„ç›®æ ‡å…ƒç´ ï¼Œè€Œæ˜¯shadow rootå…ƒç´ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fix: ç‚¹å‡»äº‹ä»¶targetä¸ºshadowå…ƒç´ çš„é—®é¢˜</span></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="attr">addEventListener</span>: oldAddEventListener, <span class="attr">removeEventListener</span>: oldRemoveEventListener&#125; = <span class="built_in">document</span>;</span><br><span class="line"><span class="keyword">const</span> fixEvents = [<span class="string">'click'</span>, <span class="string">'mousedown'</span>, <span class="string">'mouseup'</span>];</span><br><span class="line"><span class="keyword">const</span> overrideEventFnMap = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> setOverrideEvent = <span class="function">(<span class="params">eventName, fn, overrideFn</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (fn === overrideFn) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!overrideEventFnMap[eventName]) &#123;</span><br><span class="line">    overrideEventFnMap[eventName] = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  overrideEventFnMap[eventName].set(fn, overrideFn);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> resetOverrideEvent = <span class="function">(<span class="params">eventName, fn</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> eventFn = overrideEventFnMap[eventName]?.get(fn);</span><br><span class="line">  <span class="keyword">if</span> (eventFn) &#123;</span><br><span class="line">    overrideEventFnMap[eventName].delete(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> eventFn || fn;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">document</span>.addEventListener = <span class="function">(<span class="params">event, fn, options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰äº‹ä»¶å¯¹è±¡ä¸ºqiankunç›’å­ï¼Œå¹¶ä¸”å½“å‰å¯¹è±¡æœ‰shadowRootå…ƒç´ ï¼Œåˆ™fixäº‹ä»¶å¯¹è±¡ä¸ºçœŸå®å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (e.target.id?.startsWith(<span class="string">'__qiankun_microapp_wrapper'</span>) &amp;&amp; e.target?.shadowRoot) &#123;</span><br><span class="line">      fn(&#123;...e, <span class="attr">target</span>: e.path[<span class="number">0</span>]&#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fn(e);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> eventFn = fixEvents.includes(event) ? callback : fn;</span><br><span class="line">  setOverrideEvent(event, fn, eventFn);</span><br><span class="line">  <span class="built_in">Reflect</span>.apply(oldAddEventListener, <span class="built_in">document</span>, [event, eventFn, options]);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">document</span>.removeEventListener = <span class="function">(<span class="params">event, fn, options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> eventFn = resetOverrideEvent(event, fn);</span><br><span class="line">  <span class="built_in">Reflect</span>.apply(oldRemoveEventListener, <span class="built_in">document</span>, [event, eventFn, options]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="å¤ç”¨å…¬å…±ä¾èµ–"><a href="#å¤ç”¨å…¬å…±ä¾èµ–" class="headerlink" title="å¤ç”¨å…¬å…±ä¾èµ–"></a>å¤ç”¨å…¬å…±ä¾èµ–</h3><blockquote><p>æ¯”å¦‚ä¼ä¸šä¸­çš„utilã€coreã€requestã€uiç­‰å…¬å…±ä¾èµ–ï¼Œåœ¨å¾®å‰ç«¯ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ¯ä¸ªå­åº”ç”¨éƒ½åŠ è½½ä¸€æ¬¡ï¼Œè¿™æ ·æ—¢æµªè´¹èµ„æºå¹¶ä¸”è¿˜ä¼šå¯¼è‡´æœ¬æ¥å•ä¾‹çš„å¯¹è±¡ï¼Œå˜æˆäº†å¤šä¾‹ã€‚</p></blockquote><p>åœ¨webpackä¸­é…ç½®<code>externals</code>ã€‚æŠŠéœ€è¦å¤ç”¨çš„æ’é™¤æ‰“åŒ…ï¼Œç„¶ååœ¨<code>index.html</code>ä¸­åŠ è½½æ’é™¤çš„libå¤–é“¾ï¼ˆå­åº”ç”¨éœ€è¦åœ¨<code>script</code>æˆ–è€…<code>style</code>æ ‡ç­¾åŠ ä¸Š<code>ignore</code>å±æ€§ï¼Œæœ‰äº†è¿™ä¸ªå±æ€§ï¼Œqiankun ä¾¿ä¸ä¼šå†å»åŠ è½½è¿™ä¸ª js/cssï¼Œè€Œå­é¡¹ç›®ç‹¬ç«‹è¿è¡Œï¼Œè¿™äº› js/css ä»èƒ½è¢«åŠ è½½ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">ignore</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"//element-ui.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">ignore</span> <span class="attr">src</span>=<span class="string">"//element-ui.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">externals: &#123;</span><br><span class="line">  <span class="string">'element-ui'</span>: &#123;</span><br><span class="line">    commonjs: <span class="string">'element-ui'</span>,</span><br><span class="line">    commonjs2: <span class="string">'element-ui'</span>,</span><br><span class="line">    amd: <span class="string">'element-ui'</span>,</span><br><span class="line">    root: <span class="string">'ElementUI'</span> <span class="comment">// å¤–é“¾cdnåŠ è½½æŒ‚è½½åˆ°windowä¸Šçš„å˜é‡å</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="çˆ¶å­å…±äº«ï¼ˆå›½é™…åŒ–ï¼‰"><a href="#çˆ¶å­å…±äº«ï¼ˆå›½é™…åŒ–ï¼‰" class="headerlink" title="çˆ¶å­å…±äº«ï¼ˆå›½é™…åŒ–ï¼‰"></a>çˆ¶å­å…±äº«ï¼ˆå›½é™…åŒ–ï¼‰</h3><p>åº”ç”¨æ³¨å†Œæ—¶æˆ–åŠ è½½æ—¶ï¼Œå°†ä¾èµ–ä¼ é€’ç»™å­é¡¹ç›®<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œ</span></span><br><span class="line">registerMicroApps([</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'micro-1'</span>, </span><br><span class="line">    entry: <span class="string">'http://localhost:9001/micro-1'</span>, </span><br><span class="line">    container: <span class="string">'#micro-1'</span>, </span><br><span class="line">    activeRule: <span class="string">'/micro-1'</span>, </span><br><span class="line">    props: &#123; <span class="attr">i18n</span>: <span class="keyword">this</span>.$i18n &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// æ‰‹åŠ¨åŠ è½½</span></span><br><span class="line">loadMicroApp(&#123;</span><br><span class="line">  name,</span><br><span class="line">  entry,</span><br><span class="line">  container: <span class="string">`#<span class="subst">$&#123;<span class="keyword">this</span>.boxId&#125;</span>`</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    i18n: <span class="keyword">this</span>.$i18n</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>å­åº”ç”¨å¯åŠ¨æ—¶è·å–propså‚æ•°åˆå§‹åŒ–<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; i18n &#125; = props;</span><br><span class="line"><span class="keyword">if</span> (!i18n) &#123;</span><br><span class="line">  <span class="comment">// å½“ç‹¬ç«‹è¿è¡Œæ—¶æˆ–ä¸»åº”ç”¨æœªå…±äº«æ—¶ï¼ŒåŠ¨æ€åŠ è½½æœ¬åœ°å›½é™…åŒ–</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">'@/common-module/lang'</span>);</span><br><span class="line">  i18n = <span class="built_in">module</span>.default;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  i18n,</span><br><span class="line">  router,</span><br><span class="line">  render</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>ä¸»åº”ç”¨åœ¨æ³¨å†Œå­åº”ç”¨æˆ–è€…æ‰‹åŠ¨åŠ è½½å­åº”ç”¨æ—¶æŠŠå…±äº«çš„å˜é‡é€šè¿‡<code>props</code>ä¼ é€’ç»™å­åº”ç”¨ï¼Œå­åº”ç”¨åœ¨<code>bootstrap</code>æˆ–è€…<code>mount</code>é’©å­å‡½æ•°ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰ä»<code>props</code>ä¸­è·å–åˆ°è¯¥å˜é‡ï¼Œå­åº”ç”¨åˆ™åŠ¨æ€åŠ è½½æœ¬åœ°å˜é‡ã€‚</p><h3 id="keep-aliveï¼ˆVueï¼‰"><a href="#keep-aliveï¼ˆVueï¼‰" class="headerlink" title="keep-aliveï¼ˆVueï¼‰"></a>keep-aliveï¼ˆVueï¼‰</h3><blockquote><p>å…¶å®å¹¶ä¸å»ºè®®åškeepAliveï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯åšäº†ï¼Œæˆ‘èƒ½è¯´ä»€ä¹ˆâ€¦</p></blockquote><p>ç½‘ä¸Šæœ‰å…¶ä»–æ–¹æ¡ˆï¼Œæˆ‘æ²¡æœ‰é‡‡çº³ï¼Œæˆ‘åœ¨è¿™é‡Œè¯´ä¸‹æˆ‘çš„æ–¹æ¡ˆå§ï¼ˆç»¼åˆäº†ç½‘ä¸Šçš„æ–¹æ¡ˆï¼‰ï¼Œä½¿ç”¨<code>loadMicroApp</code>æ‰‹åŠ¨åŠ è½½å’Œå¸è½½å­åº”ç”¨ã€‚è¿™é‡Œæœ‰å‡ ä¸ªéš¾ç‚¹ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// microApp.js (å¯ä»¥èµ°CI/CDè¿ç»´é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¥å£ä»æœåŠ¡å™¨è·å–)</span></span><br><span class="line"><span class="keyword">const</span> apps = [&#123;</span><br><span class="line">  name: <span class="string">'micro-1'</span>,</span><br><span class="line">  activeRule: <span class="string">'/micro-1'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  name: <span class="string">'micro-2'</span>,</span><br><span class="line">  activeRule: <span class="string">'/micro-2'</span>,</span><br><span class="line">  prefetch: <span class="literal">true</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  name: <span class="string">'micro-3'</span>,</span><br><span class="line">  activeRule: <span class="string">'/micro-3'</span>,</span><br><span class="line">  prefetch: <span class="literal">false</span>, <span class="comment">// é¢„åŠ è½½èµ„æº</span></span><br><span class="line">  preload: <span class="literal">false</span>, <span class="comment">// é¢„æ¸²æŸ“</span></span><br><span class="line">  keepalive: <span class="literal">true</span> <span class="comment">// ç¼“å­˜å­åº”ç”¨</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> apps.map(<span class="function"><span class="params">app</span> =&gt;</span> (&#123; ...app, <span class="attr">entry</span>: getEntryUrl(app.name) &#125;));</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div</span><br><span class="line">    v-show=&quot;isActive&quot;</span><br><span class="line">    :id=&quot;boxId&quot;</span><br><span class="line">    :class=&quot;b()&quot;</span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; loadMicroApp &#125; from &apos;qiankun&apos;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &apos;MicroApp&apos;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    app: &#123;</span><br><span class="line">      type: Object,</span><br><span class="line">      required: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  inject: [&apos;appLayout&apos;],</span><br><span class="line">  computed: &#123;</span><br><span class="line">    boxId() &#123;</span><br><span class="line">      return `micro-app_$&#123;this.app.name&#125;`;</span><br><span class="line">    &#125;,</span><br><span class="line">    activeRule() &#123;</span><br><span class="line">      return this.app.activeRule;</span><br><span class="line">    &#125;,</span><br><span class="line">    currentPath() &#123;</span><br><span class="line">      return this.$route.fullPath;</span><br><span class="line">    &#125;,</span><br><span class="line">    // åˆ¤æ–­å½“å‰å­åº”ç”¨æ˜¯å¦ä¸ºæ¿€æ´»çŠ¶æ€</span><br><span class="line">    isActive() &#123;</span><br><span class="line">      const &#123;activeRule, currentPath&#125; = this;</span><br><span class="line">      const rules = Array.isArray(activeRule) ? [ ...activeRule ] : [activeRule];</span><br><span class="line">      return rules.some(rule =&gt; &#123;</span><br><span class="line">        if (typeof rule === &apos;function&apos;) &#123;</span><br><span class="line">          return rule(currentPath);</span><br><span class="line">        &#125;</span><br><span class="line">        return currentPath.startsWith(`$&#123;rule&#125;`);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    isKeepalive() &#123;</span><br><span class="line">      return this.app.keepalive;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    isActive: &#123;</span><br><span class="line">      handler() &#123;</span><br><span class="line">        this.onActiveChange();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created () &#123;</span><br><span class="line">    // éœ€è¦ç­‰spa startåå†åŠ è½½åº”ç”¨ï¼Œæ‰ä¼šæœ‰shadowèŠ‚ç‚¹</span><br><span class="line">    this.$once(&apos;started&apos;, () =&gt; &#123;</span><br><span class="line">      this.init();</span><br><span class="line">    &#125;);</span><br><span class="line">    // æŠŠå½“å‰å®ä¾‹åŠ å…¥åˆ°layoutä¸­</span><br><span class="line">    this.appLayout.apps.set(this.app.name, this);</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    init() &#123;</span><br><span class="line">      // é¢„æŒ‚è½½</span><br><span class="line">      if (this.app.preload) &#123;</span><br><span class="line">        this.load();</span><br><span class="line">      &#125;</span><br><span class="line">      // å¦‚æœè·¯ç”±ç›´æ¥è¿›å…¥å½“å‰åº”ç”¨åˆ™ä¼šåœ¨è¿™é‡ŒæŒ‚è½½</span><br><span class="line">      this.onActiveChange();</span><br><span class="line">    &#125;,</span><br><span class="line">    /**</span><br><span class="line">     * åŠ è½½å¾®åº”ç”¨</span><br><span class="line">     * @returns &#123;Promise&lt;void&gt;&#125;</span><br><span class="line">     */</span><br><span class="line">    async load() &#123;</span><br><span class="line">      if (!this.appInstance) &#123;</span><br><span class="line">        const &#123; name, entry, preload &#125; = this.app;</span><br><span class="line">        this.appInstance = loadMicroApp(&#123;</span><br><span class="line">          name,</span><br><span class="line">          entry,</span><br><span class="line">          container: `#$&#123;this.boxId&#125;`,</span><br><span class="line">          props: &#123;</span><br><span class="line">            ...,</span><br><span class="line">            appName: name,</span><br><span class="line">            preload,</span><br><span class="line">            active: this.isActive</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        await this.appInstance.mountPromise;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    /**</span><br><span class="line">     * çŠ¶æ€å˜æ›´</span><br><span class="line">     * @returns &#123;Promise&lt;void&gt;&#125;</span><br><span class="line">     */</span><br><span class="line">    async onActiveChange() &#123;</span><br><span class="line">      // è§¦å‘å…¨å±€äº‹ä»¶</span><br><span class="line">      this.eventBus.$emit(`$&#123;this.isActive ? &apos;activated&apos; : &apos;deactivated&apos;&#125;:$&#123;this.app.name&#125;`);</span><br><span class="line">      // å¦‚æœå½“å‰ä¸ºæ¿€æ´»åˆ™åŠ è½½</span><br><span class="line">      if (this.isActive) &#123;</span><br><span class="line">        await this.load();</span><br><span class="line">      &#125;</span><br><span class="line">      // å¦‚æœå½“å‰ä¸ºå¤±æ•ˆå¹¶ä¸”å½“å‰åº”ç”¨å·²åŠ è½½å¹¶ä¸”é…ç½®ä¸ºä¸ç¼“å­˜åˆ™å¸è½½å½“å‰åº”ç”¨</span><br><span class="line">      if (!this.isActive &amp;&amp; this.appInstance &amp;&amp; !this.isKeepalive) &#123;</span><br><span class="line">        await this.appInstance.unmount();</span><br><span class="line">        this.appInstance = null;</span><br><span class="line">      &#125;</span><br><span class="line">      // é€šçŸ¥å¸ƒå±€å½“å‰çŠ¶æ€å˜æ›´</span><br><span class="line">      this.$emit(&apos;active&apos;, this.isActive);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// App.vue (layout)</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;template v-if=&quot;!isMicroApp&quot;&gt;</span><br><span class="line">    &lt;keep-alive&gt;</span><br><span class="line">      &lt;router-view v-if=&quot;keepAlive&quot; /&gt;</span><br><span class="line">    &lt;/keep-alive&gt;</span><br><span class="line">    &lt;router-view v-if=&quot;!keepAlive&quot; /&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;micro-app</span><br><span class="line">    v-for=&quot;app of microApps&quot;</span><br><span class="line">    :key=&quot;app.name&quot;</span><br><span class="line">    :app=&quot;app&quot;</span><br><span class="line">    @active=&quot;onMicroActive&quot;</span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    isMicroApp() &#123;</span><br><span class="line">      return !!this.currentMicroApp;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    // å¯åŠ¨qiankunä¸»åº”ç”¨ï¼Œå¼€å¯å¤šä¾‹ä¸ä¸¥æ ¼æ ·å¼éš”ç¦»æ²™ç®±ï¼ˆshadow domï¼‰</span><br><span class="line">    start(&#123; singular: false, sandbox: &#123; strictStyleIsolation: true &#125; &#125;);</span><br><span class="line">    // è¿‡æ»¤å‡ºéœ€è¦é¢„åŠ è½½çš„å­åº”ç”¨è¿›è¡Œèµ„æºé¢„åŠ è½½</span><br><span class="line">    const prefetchAppList = this.microApps.filter(item =&gt; item.prefetch);</span><br><span class="line">    if (prefetchAppList.length) &#123;</span><br><span class="line">      // å»¶è¿Ÿæ‰§è¡Œï¼Œæ”¾ç½®å½±å“å½“å‰è®¿é—®çš„åº”ç”¨èµ„æºåŠ è½½</span><br><span class="line">      (window.requestIdleCallback || setTimeout)(() =&gt; prefetchApps(prefetchAppList));</span><br><span class="line">    &#125;</span><br><span class="line">    // è§¦å‘å¾®åº”ç”¨çš„åˆå§‹åŒ–äº‹ä»¶ï¼Œä»£è¡¨spaå·²ç»startedäº†</span><br><span class="line">    this.appValues.forEach(app =&gt; app.$emit(&apos;started&apos;));</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    onMicroActive() &#123;</span><br><span class="line">      this.currentMicroApp = this.appValues.find(item =&gt; item.isActive);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><ol><li>è·¯ç”±çš„å“åº”ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¸è½½keepAliveçš„å­åº”ç”¨ï¼Œåˆ™å­åº”ç”¨ä¾ç„¶ä¼šå“åº”è·¯ç”±çš„å˜åŒ–ï¼Œä»è€Œå¯¼è‡´å­åº”ç”¨çš„å½“å‰è·¯ç”±å·²ç»ä¸æ˜¯ç¦»å¼€æ—¶çš„è·¯ç”±äº†ã€‚</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®©vue-routeræ”¯æŒkeepaliveï¼Œå½“ä¸»è·¯ç”±å˜æ›´æ—¶å¦‚æœå½“å‰å­åº”ç”¨æ²¡æœ‰è¯¥è·¯ç”±åˆ™ä¸åšå¤„ç†</span></span><br><span class="line"><span class="comment"> * å› ä¸ºé€šè¿‡æµè§ˆå™¨å‰è¿›åé€€ä¼šå…ˆè§¦å‘ä¸»è·¯ç”±çš„ç›‘å¬ï¼Œå¯¼è‡´æ²¡æœ‰åŠæ—¶é€šçŸ¥åˆ°å­åº”ç”¨deactivatedï¼Œåˆ™å­åº”ç”¨è·¯ç”±æ²¡æœ‰åŠæ—¶åœæ­¢ç›‘å¬ï¼Œåˆ™ä¼šå¤„ç†æœ¬æ¬¡ä¸»è·¯ç”±å˜æ›´</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">router</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> supportKeepAlive = <span class="function">(<span class="params">router</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> old = router.history.transitionTo;</span><br><span class="line">  router.history.transitionTo = <span class="function">(<span class="params">location, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> matched = router.getMatchedComponents(location);</span><br><span class="line">    <span class="keyword">if</span> (!matched || !matched.length) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Reflect</span>.apply(old, router.history, [location, cb]);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// é‡å†™ç›‘å¬è·¯ç”±å˜æ›´äº‹ä»¶</span></span><br><span class="line">supportKeepAlive(instance.$router);</span><br><span class="line"><span class="comment">// å¦‚æœä¸ºé¢„æŒ‚è½½å¹¶ä¸”å½“å‰ä¸ä¸ºæ¿€æ´»çŠ¶æ€åˆ™åœæ­¢ç›‘å¬è·¯ç”±ï¼Œå¹¶è®¾ç½®_startLocationä¸ºç©ºï¼Œä¸ºäº†åœ¨æ¿€æ´»çš„æ—¶å€™å¯ä»¥å“åº”</span></span><br><span class="line"><span class="keyword">if</span> (preload &amp;&amp; !active) &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰å­åº”ç”¨ä¸æ˜¯é¢„åŠ è½½ï¼ˆæˆ‘è¿™é‡Œåšäº†å¤šä¸ªå­åº”ç”¨å¹¶å­˜ä¸”å¯ä»¥é¢„åŠ è½½ï¼‰ï¼Œå¹¶ä¸”è®¿é—®çš„ä¸æ˜¯å½“å‰å­åº”ç”¨åˆ™æŠŠè·¯ç”±åœæ­¢</span></span><br><span class="line">  instance.$router.history.teardown();</span><br><span class="line">  instance.$router.history._startLocation = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>é¡µé¢çš„<code>activated</code>ä¸<code>deactivated</code>è§¦å‘ã€‚<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å­åº”ç”¨åˆ›å»ºçš„æ—¶å€™ç›‘å¬æ¿€æ´»ä¸å¤±æ•ˆäº‹ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (eventBus) &#123;</span><br><span class="line">  eventBus.$on(<span class="string">`activated:<span class="subst">$&#123;appName&#125;</span>`</span>, activated);</span><br><span class="line">  eventBus.$on(<span class="string">`deactivated:<span class="subst">$&#123;appName&#125;</span>`</span>, deactivated);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å½“å‰è·¯ç”±çš„ç»„ä»¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;*&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getCurrentRouteInstance = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;matched&#125; = instance?.$route || &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (matched?.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; instances &#125; = matched[matched.length - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (instances) &#123;</span><br><span class="line">      <span class="keyword">return</span> instances.default || instances;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§¦å‘å½“å‰è·¯ç”±ç»„ä»¶hook</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="variable">hook</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> fireCurrentRouterInstanceHook = <span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> com = getCurrentRouteInstance();</span><br><span class="line">  <span class="keyword">const</span> fns = com?.$options?.[hook];</span><br><span class="line">  <span class="keyword">if</span> (fns) &#123;</span><br><span class="line">    fns.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="built_in">Reflect</span>.apply(fn, com, [&#123; <span class="attr">micro</span>: <span class="literal">true</span> &#125;]));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¿€æ´»å½“å‰å­åº”ç”¨å›è°ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> activated = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  instance?.$router.history.setupListeners();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setupListeners'</span>);</span><br><span class="line">  fireCurrentRouterInstanceHook(<span class="string">'activated'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢« keep-alive ç¼“å­˜çš„ç»„ä»¶åœç”¨æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> deactivated = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  instance?.$router.history.teardown();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'teardown'</span>);</span><br><span class="line">  fireCurrentRouterInstanceHook(<span class="string">'deactivated'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ol><h3 id="vuex-å…¨å±€çŠ¶æ€å…±äº«ï¼ˆæ…ç”¨ï¼Œç ´åäº†vuexçš„ç†å¿µ-ä¸é€‚ç”¨ä¸å¤§é‡çš„æ•°æ®ï¼‰"><a href="#vuex-å…¨å±€çŠ¶æ€å…±äº«ï¼ˆæ…ç”¨ï¼Œç ´åäº†vuexçš„ç†å¿µ-ä¸é€‚ç”¨ä¸å¤§é‡çš„æ•°æ®ï¼‰" class="headerlink" title="vuex å…¨å±€çŠ¶æ€å…±äº«ï¼ˆæ…ç”¨ï¼Œç ´åäº†vuexçš„ç†å¿µ, ä¸é€‚ç”¨ä¸å¤§é‡çš„æ•°æ®ï¼‰"></a>vuex å…¨å±€çŠ¶æ€å…±äº«ï¼ˆæ…ç”¨ï¼Œç ´åäº†vuexçš„ç†å¿µ, ä¸é€‚ç”¨ä¸å¤§é‡çš„æ•°æ®ï¼‰</h3><blockquote><p>å­åº”ç”¨ä½¿ç”¨è‡ªå·±çš„vuexã€‚å¹¶ä¸æ˜¯çœŸæ­£çš„ä½¿ç”¨ä¸»åº”ç”¨çš„vuexã€‚éœ€è¦æ­å–œçš„vuexæ¨¡å—ä¸»åº”ç”¨ä¸å­åº”ç”¨ç†è®ºæ¥è¯´æ˜¯å¼•ç”¨çš„ç›¸åŒçš„æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªvuexæ¨¡å—æ ‡è®°å®ƒæ˜¯å¦éœ€è¦å…±äº«<br>å¹¶watchä¸»åº”ç”¨ä¸å­åº”ç”¨çš„è¯¥æ¨¡å—ã€‚å½“å­åº”ç”¨ä¸­çš„stateå‘ç”Ÿäº†æ”¹å˜åˆ™æ›´æ–°ä¸»åº”ç”¨çš„stateï¼Œç›¸åä¸»åº”ç”¨çš„stateå˜æ›´åä¹ŸåŒæ ·ä¿®æ”¹å­åº”ç”¨çš„stateã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å‘½åç©ºé—´çŠ¶æ€æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>state çŠ¶æ€æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>namespace å‘½åç©ºé—´</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;*&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> getNamespaceState = <span class="function">(<span class="params">state, namespace</span>) =&gt;</span> namespace === <span class="string">'root'</span> ? state : <span class="keyword">get</span>(state, namespace);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ›´æ–°çŠ¶æ€æ•°æ®</span><br><span class="line"> * @param store çŠ¶æ€å­˜å‚¨</span><br><span class="line"> * @param namespace å‘½åç©ºé—´</span><br><span class="line"> * @param value æ–°çš„å€¼</span><br><span class="line"> * @returns &#123;*&#125;</span><br><span class="line"> *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">const updateStoreState = (store, namespace, value) =&gt; store._withCommit(() =&gt; setVo(getNamespaceState(store.state, namespace), value));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span>**</span><br><span class="line"> * ç›‘å¬çŠ¶æ€å­˜å‚¨</span><br><span class="line"> * @param store çŠ¶æ€å­˜å‚¨</span><br><span class="line"> * @param fn å˜æ›´äº‹ä»¶å‡½æ•°</span><br><span class="line"> * @param namespace å‘½åç©ºé—´</span><br><span class="line"> * @returns &#123;*&#125;</span><br><span class="line"> * @private</span><br><span class="line"> *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">const _watch = (store, fn, namespace) =&gt; store.watch(state =&gt; getNamespaceState(state, namespace), fn, &#123; deep: true &#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const updateSubStoreState = (stores, ns, value) =&gt; stores.filter(s =&gt; s.__shareNamespaces.has(ns)).forEach(s =&gt; updateStoreState(s, ns, value));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default (store, mainStore) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ å¦‚æœæœ‰ä¸»åº”ç”¨å­˜å‚¨åˆ™å¼€å¯å…±äº«</span></span><br><span class="line"><span class="regexp">  if (mainStore) &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ å¤šä¸ªå­åº”ç”¨ä¸ä¸»åº”ç”¨å…±äº«æ—¶åˆ¤æ–­ä¸»åº”ç”¨å­˜å‚¨æ˜¯å¦å·²ç»æ ‡è®°ä¸ºå·²å…±äº«</span></span><br><span class="line"><span class="regexp">    if (mainStore.__isShare !== true) &#123;</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ æ‰€æœ‰å­åº”ç”¨çŠ¶æ€</span></span><br><span class="line"><span class="regexp">      mainStore.__subStores = new Set();</span></span><br><span class="line"><span class="regexp">      /</span><span class="regexp">/ å·²ç›‘å¬çš„å‘½åç©ºé—´</span></span><br><span class="line"><span class="regexp">      mainStore.__subWatchs = new Map();</span></span><br><span class="line"><span class="regexp">      mainStore.__isShare = true;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ æŠŠå½“å‰å­åº”ç”¨å­˜å‚¨æ”¾å…¥ä¸»åº”ç”¨é‡Œé¢</span></span><br><span class="line"><span class="regexp">    mainStore.__subStores.add(store);</span></span><br><span class="line"><span class="regexp">    const shareNames = new Set();</span></span><br><span class="line"><span class="regexp">    const &#123; _modulesNamespaceMap: moduleMap &#125; = store;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ ç›‘å¬å½“å‰storeï¼Œæ›´æ–°ä¸»åº”ç”¨storeï¼Œå¹¶ç»Ÿè®¡è¯¥å­åº”ç”¨éœ€è¦å…±äº«çš„æ‰€æœ‰å‘½åç©ºé—´</span></span><br><span class="line"><span class="regexp">    Object.keys(moduleMap).forEach(key =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      const names = key.split('/</span><span class="string">').filter(k =&gt; !!k);</span></span><br><span class="line"><span class="string">      // å¦‚æœè¯¥å‘½åç©ºé—´çš„ä¸Šçº§å‘½åç©ºé—´å·²ç»å…±äº«åˆ™ä¸‹çº§ä¸éœ€è¦å†å…±äº«</span></span><br><span class="line"><span class="string">      const has = names.some(name =&gt; shareNames.has(name));</span></span><br><span class="line"><span class="string">      if (has) &#123;</span></span><br><span class="line"><span class="string">        return;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      const &#123; _rawModule: &#123; share &#125; &#125; = moduleMap[key];</span></span><br><span class="line"><span class="string">      if (share === true) &#123;</span></span><br><span class="line"><span class="string">        const namespace = names.join('</span>.<span class="string">');</span></span><br><span class="line"><span class="string">        // ç›‘å¬å½“å‰å­åº”ç”¨å­˜å‚¨çš„å‘½åç©ºé—´ï¼Œå‘ç”Ÿå˜åŒ–åæ›´æ–°ä¸»åº”ç”¨ä¸ä¹‹åŒåçš„å‘½åç©ºé—´æ•°æ®</span></span><br><span class="line"><span class="string">        _watch(store, value =&gt; updateStoreState(mainStore, namespace, value), namespace);</span></span><br><span class="line"><span class="string">        shareNames.add(namespace);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // å­˜å‚¨å½“å‰å­åº”ç”¨éœ€è¦å…±äº«çš„å‘½åç©ºé—´</span></span><br><span class="line"><span class="string">    store.__shareNamespaces = shareNames;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    shareNames.forEach(ns =&gt; &#123;</span></span><br><span class="line"><span class="string">      // ä»ä¸»åº”ç”¨åŒæ­¥æ•°æ®</span></span><br><span class="line"><span class="string">      updateStoreState(store, ns, getNamespaceState(mainStore.state, ns));</span></span><br><span class="line"><span class="string">      if (mainStore.__subWatchs.has(ns)) &#123;</span></span><br><span class="line"><span class="string">        return;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      // ç›‘å¬ä¸»åº”ç”¨çš„çŠ¶æ€ï¼Œæ›´æ–°å­åº”ç”¨å­˜å‚¨</span></span><br><span class="line"><span class="string">      const w = mainStore.watch(state =&gt; getNamespaceState(state, ns), value =&gt; updateSubStoreState([...mainStore.__subStores], ns, value), &#123; deep: true &#125;);</span></span><br><span class="line"><span class="string">      console.log(`ä¸»åº”ç”¨storeç›‘å¬æ¨¡å—ã€$&#123;ns&#125;ã€‘æ•°æ®`);</span></span><br><span class="line"><span class="string">      mainStore.__subWatchs.set(ns, w);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  return store;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> å¾®å‰ç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> single spa </tag>
            
            <tag> qiankun </tag>
            
            <tag> å¾®å‰ç«¯ </tag>
            
            <tag> ä¹¾å¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue history å¤šæ¨¡å—nginxé…ç½®</title>
      <link href="/2020/07/07/vue-history-%E5%A4%9A%E6%A8%A1%E5%9D%97nginx%E9%85%8D%E7%BD%AE/"/>
      <url>/2020/07/07/vue-history-%E5%A4%9A%E6%A8%A1%E5%9D%97nginx%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>vue-router historyæ¨¡å¼æ¯”hashæ¨¡å¼æœ‰å¾ˆå¤šå¥½å¤„ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸è¯¦ç»†è¯´äº†ï¼Œä¸»è¦æœ‰ä¸€ç‚¹ï¼š<br>å½“æˆ‘ä»¬ç”¨åˆ†äº«çš„æ—¶å€™ï¼Œæˆ–è€…æŠŠurlæš´éœ²ç»™åˆ«äººç”¨çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™ä¼šç»è¿‡urlç¼–ç å°±ä¼šå¯¼è‡´hashçš„#ç¬¦å·è¢«è½¬ç ï¼Œç„¶åå¯¼è‡´æ•´ä¸ªè·¯ç”±é”™è¯¯ã€‚</p><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨historyæ¨¡å¼çš„æ—¶å€™ä¸€èˆ¬æ˜¯éœ€è¦é…ç½®nginxçš„tryfilesçš„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªnginx åŸŸåä¸­ä½¿ç”¨äº†2ä¸ªæˆ–è€…å¤šä¸ªvue spa çš„historyæ¨¡å¼åˆ™ä¼š<br>å¯¼è‡´æ— æ³•è¿›å…¥å…¶ä»–æ¨¡å—çš„é¡µé¢ï¼Œå› ä¸ºéƒ½ä¼šè¢«tryfilesè½¬åˆ°/çš„index.htmlé¡µé¢ã€‚</p><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><h3 id="ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º-å…¶æ¬¡éƒ½åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…"><a href="#ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º-å…¶æ¬¡éƒ½åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…" class="headerlink" title="ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º/å…¶æ¬¡éƒ½åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…"></a>ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º<code>/</code>å…¶æ¬¡éƒ½åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…</h3><h4 id="ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œé¦–é¡µæ¨¡å—"><a href="#ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œé¦–é¡µæ¨¡å—" class="headerlink" title="ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œé¦–é¡µæ¨¡å—"></a>ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œé¦–é¡µæ¨¡å—</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   /usr/vue/project1/dist/;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    try_files $uri $uri/ /index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¬¬äºŒä¸ªæ¨¡å—"><a href="#ç¬¬äºŒä¸ªæ¨¡å—" class="headerlink" title="ç¬¬äºŒä¸ªæ¨¡å—"></a>ç¬¬äºŒä¸ªæ¨¡å—</h4><p>è¿™é‡Œçš„project2å…¶å®æ˜¯æ”¾åœ¨project1çš„disté‡Œé¢çš„ã€‚å½“ç„¶ä¹Ÿæ”¾åœ¨å¤–é¢æ›´å¥½é…ç½®ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œåªèƒ½ç”¨aliasä¸èƒ½ç”¨rootã€‚è€Œè¿™é‡Œçš„try_filesçš„rootåˆ™ä¸ºç¬¬ä¸€ä¸ªæ¨¡å—çš„rootã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /project2 &#123;</span><br><span class="line">    try_files $uri $uri/ /project2/$uri /project2/index.html;</span><br><span class="line">    alias /usr/vue/project1/dist/project2/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ç¬¬äºŒä¸ªæˆ–è€…ç¬¬ä¸‰ä¸ªæ¨¡å—çš„è¿›å…¥ç‚¹æ˜¯åœ¨ç¬¬ä¸€ä¸ªé‡Œé¢çš„è¯åˆ™vue-routerçš„baseå¿…é¡»ä¸å…¶ä¸€è‡´ï¼Œä¾‹å¦‚ï¼š<br>ç¬¬ä¸€ä¸ªæ¨¡å—åœ°å€: <a href="https://www.alone.com/project1" target="_blank" rel="noopener">https://www.alone.com/project1</a><br>ç¬¬äºŒä¸ªæ¨¡å—åœ°å€: <a href="https://www.alone.com/project1/project2" target="_blank" rel="noopener">https://www.alone.com/project1/project2</a><br>é‚£routerçš„baseä¸ºï¼š/project1/project2 å¦åˆ™æ— æ³•è¿›å…¥è·¯ç”±ã€‚</p><h3 id="ä¸åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…"><a href="#ä¸åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…" class="headerlink" title="ä¸åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…"></a>ä¸åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—å†…</h3><h4 id="ç¬¬ä¸€ä¸ªæ¨¡å—"><a href="#ç¬¬ä¸€ä¸ªæ¨¡å—" class="headerlink" title="ç¬¬ä¸€ä¸ªæ¨¡å—"></a>ç¬¬ä¸€ä¸ªæ¨¡å—</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /project1 &#123;</span><br><span class="line">    root   /usr/vue/;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    try_files $uri $uri/ /project1/dist/index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·¯ç”±baseé…ç½®ä¸º: /project1<br>è®¿é—®åœ°å€: <a href="https://www.alone.com/project1" target="_blank" rel="noopener">https://www.alone.com/project1</a></p><h4 id="ç¬¬Nä¸ªæ¨¡å—"><a href="#ç¬¬Nä¸ªæ¨¡å—" class="headerlink" title="ç¬¬Nä¸ªæ¨¡å—"></a>ç¬¬Nä¸ªæ¨¡å—</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /project2 &#123;</span><br><span class="line">    alias /usr/vue/project2/dist/;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    try_files $uri $uri/ /project2/dist/index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·¯ç”±baseé…ç½®ä¸º: /project2<br>è®¿é—®åœ°å€: <a href="https://www.alone.com/project2" target="_blank" rel="noopener">https://www.alone.com/project2</a></p>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> vue </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
            <tag> history </tag>
            
            <tag> nginx </tag>
            
            <tag> vue router </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue prerender-spa-plugin é¢„æ¸²æŸ“</title>
      <link href="/2020/06/18/vue-prerender-spa-plugin-%E9%A2%84%E6%B8%B2%E6%9F%93/"/>
      <url>/2020/06/18/vue-prerender-spa-plugin-%E9%A2%84%E6%B8%B2%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<p>åœ¨åšVUE H5å•é¡µé¢è½»åº”ç”¨çš„æ—¶å€™ï¼Œå¦‚æœä¸ä¼˜åŒ–åˆ™è¿›å…¥é¡µé¢ä¼šå¾ˆé•¿æ—¶é—´çš„ç™½å±ï¼Œæœ‰å¾ˆå¤šç§ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦è®²<code>prerender-spa-plugin</code>é¢„æ¸²æŸ“ã€‚</p><h2 id="åŸç†ï¼š"><a href="#åŸç†ï¼š" class="headerlink" title="åŸç†ï¼š"></a>åŸç†ï¼š</h2><p><a href="https://github.com/chrisvfritz/prerender-spa-plugin" target="_blank" rel="noopener">prerender-spa-plugin</a> åˆ©ç”¨äº† Puppeteer çš„çˆ¬å–é¡µé¢çš„åŠŸèƒ½ã€‚ Puppeteer æ˜¯ä¸€ä¸ª Chromeå®˜æ–¹å‡ºå“çš„ headlessChromenode åº“ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—çš„ API, å¯ä»¥åœ¨æ—  UI çš„æƒ…å†µä¸‹è°ƒç”¨ Chrome çš„åŠŸèƒ½, é€‚ç”¨äºçˆ¬è™«ã€è‡ªåŠ¨åŒ–å¤„ç†ç­‰å„ç§åœºæ™¯ã€‚å®ƒå¾ˆå¼ºå¤§ï¼Œæ‰€ä»¥å¾ˆç®€å•å°±èƒ½å°†è¿è¡Œæ—¶çš„ HTML æ‰“åŒ…åˆ°æ–‡ä»¶ä¸­ã€‚åŸç†æ˜¯åœ¨ Webpack æ„å»ºé˜¶æ®µçš„æœ€åï¼Œåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª Puppeteer çš„æœåŠ¡ï¼Œè®¿é—®é…ç½®äº†é¢„æ¸²æŸ“çš„è·¯ç”±ï¼Œç„¶åå°† Puppeteer ä¸­æ¸²æŸ“çš„é¡µé¢è¾“å‡ºåˆ° HTML æ–‡ä»¶ä¸­ï¼Œå¹¶å»ºç«‹è·¯ç”±å¯¹åº”çš„ç›®å½•ã€‚</p><p>ä¾‹å¦‚è·¯ç”±ï¼š/demo/add æˆå“ç»“æ„:</p><pre><code>dist--demo----add------index.html</code></pre><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D prerender-spa-plugin</span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>åœ¨vue.config.jsä¸­é…ç½®webpackä¿¡æ¯</p><ol><li><p>åœ¨é¡¶éƒ¨å¯¼å…¥ä¾èµ–</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> PrerenderSPAPlugin = <span class="built_in">require</span>(<span class="string">'prerender-spa-plugin'</span>);</span><br></pre></td></tr></table></figure></li><li><p>åœ¨configureWebpackèŠ‚ç‚¹ä¸‹é…ç½®ï¼ŒconfigureWebpackä¸ºfunctionï¼Œä½ ä¹Ÿå¯ä»¥ç”¨chainWebpacké“¾å¼é…ç½®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨webpacké…ç½®pluginsèŠ‚ç‚¹ã€‚</p></li></ol><ul><li><p>configureWebpackä¸ºfunction</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config.plugins.push(<span class="keyword">new</span> PrerenderSPAPlugin(&#123;</span><br><span class="line">    <span class="comment">// Required - The path to the webpack-outputted app to prerender.</span></span><br><span class="line">    staticDir: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    <span class="comment">// Required - Routes to render.</span></span><br><span class="line">    routes: [<span class="string">'/demo/add'</span>]</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure></li><li><p>chainWebpacké“¾å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config.plugin(<span class="string">'prerender'</span>).use(PrerenderSPAPlugin, [&#123;</span><br><span class="line">    <span class="comment">// Required - The path to the webpack-outputted app to prerender.</span></span><br><span class="line">    staticDir: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    <span class="comment">// Required - Routes to render.</span></span><br><span class="line">    routes: [<span class="string">'/demo/add'</span>]</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure></li></ul><p>build å°±èƒ½çœ‹åˆ°æ•ˆæœäº†ã€‚ä¼šåœ¨distç›®å½•ç”Ÿæˆä¸è·¯ç”±å¯¹åº”çš„é™æ€æ–‡ä»¶index.htmlã€‚å¹¶ä¸”åœ¨ä½ æŒ‚è½½çš„divé‡Œé¢æœ‰å½“å‰è·¯ç”±çš„é™æ€å…ƒç´ ã€‚</p><h2 id="ä¸Šé¢è¯´çš„æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨çœŸæ­£åœºæ™¯ä¸­ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªï¼Œå¹¶ç»™å‡ºæ–¹æ¡ˆã€‚"><a href="#ä¸Šé¢è¯´çš„æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨çœŸæ­£åœºæ™¯ä¸­ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªï¼Œå¹¶ç»™å‡ºæ–¹æ¡ˆã€‚" class="headerlink" title="ä¸Šé¢è¯´çš„æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨çœŸæ­£åœºæ™¯ä¸­ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªï¼Œå¹¶ç»™å‡ºæ–¹æ¡ˆã€‚"></a>ä¸Šé¢è¯´çš„æ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨çœŸæ­£åœºæ™¯ä¸­ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªï¼Œå¹¶ç»™å‡ºæ–¹æ¡ˆã€‚</h2><h3 id="å½“publicPathä¸ä¸º-çš„æ—¶å€™ä¾‹å¦‚-device-ï¼Œéœ€è¦åœ¨PrerenderSPAPluginæ’ä»¶é…ç½®indexPath"><a href="#å½“publicPathä¸ä¸º-çš„æ—¶å€™ä¾‹å¦‚-device-ï¼Œéœ€è¦åœ¨PrerenderSPAPluginæ’ä»¶é…ç½®indexPath" class="headerlink" title="å½“publicPathä¸ä¸º/çš„æ—¶å€™ä¾‹å¦‚:/device/ï¼Œéœ€è¦åœ¨PrerenderSPAPluginæ’ä»¶é…ç½®indexPath"></a>å½“publicPathä¸ä¸º<code>/</code>çš„æ—¶å€™ä¾‹å¦‚:<code>/device/</code>ï¼Œéœ€è¦åœ¨<code>PrerenderSPAPlugin</code>æ’ä»¶é…ç½®<code>indexPath</code></h3><p>å‚è€ƒissue <a href="https://github.com/chrisvfritz/prerender-spa-plugin/issues/344#issuecomment-619475952" target="_blank" rel="noopener">https://github.com/chrisvfritz/prerender-spa-plugin/issues/344#issuecomment-619475952</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PrerenderSPAPlugin(&#123;</span><br><span class="line">    <span class="comment">// Required - The path to the webpack-outputted app to prerender.</span></span><br><span class="line">    staticDir: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    indexPath: path.resolve(__dirname, <span class="string">`./dist<span class="subst">$&#123;config.output.publicPath&#125;</span>index.html`</span>),</span><br><span class="line">    <span class="comment">// Required - Routes to render.</span></span><br><span class="line">    routes: [<span class="string">'/device/demo/add'</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>é…ç½®vue.config.jså±æ€§<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    publicPath: <span class="string">'/device/'</span>,</span><br><span class="line">    outputPath: <span class="string">'dist/device/'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">å¹¶ä¸”ä¼šæ‰“åŒ…åˆ°dist/device/ç›®å½•ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### åœ¨é¢„æ¸²æŸ“çš„æ—¶å€™ä¸åˆå§‹åŒ–æŸäº›ä¸œè¥¿ï¼Œä¾‹å¦‚ï¼šä¸æƒ³æŠŠ`</span>vConsole<span class="string">`é¢„æ¸²æŸ“ã€‚</span></span><br><span class="line"><span class="string">é…ç½® æ’ä»¶çš„renderå±æ€§</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="keyword">new</span> PrerenderSPAPlugin(&#123;</span><br><span class="line">    <span class="comment">// Required - The path to the webpack-outputted app to prerender.</span></span><br><span class="line">    staticDir: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    indexPath: path.resolve(__dirname, <span class="string">`./dist<span class="subst">$&#123;config.output.publicPath&#125;</span>index.html`</span>),</span><br><span class="line">    <span class="comment">// Required - Routes to render.</span></span><br><span class="line">    routes: [<span class="string">'/device/demo/add'</span>],</span><br><span class="line">    renderer: <span class="keyword">new</span> Renderer(&#123;</span><br><span class="line">        injectProperty: <span class="string">'__PRERENDER_INJECTED__'</span>,</span><br><span class="line">        inject: <span class="string">'prerender'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨<code>vConsole</code>åˆå§‹åŒ–çš„åœ°æ–¹åˆ¤æ–­<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isPrerender = <span class="built_in">window</span>.__PRERENDER_INJECTED__ === <span class="string">'prerender'</span>;</span><br><span class="line"><span class="keyword">if</span> (!isPrerender) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–vConsole</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æƒ³åœ¨vueæŒ‚è½½åæ¸²æŸ“"><a href="#æƒ³åœ¨vueæŒ‚è½½åæ¸²æŸ“" class="headerlink" title="æƒ³åœ¨vueæŒ‚è½½åæ¸²æŸ“"></a>æƒ³åœ¨vueæŒ‚è½½åæ¸²æŸ“</h3><p>é…ç½® æ’ä»¶çš„renderå±æ€§<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PrerenderSPAPlugin(&#123;</span><br><span class="line">    <span class="comment">// Required - The path to the webpack-outputted app to prerender.</span></span><br><span class="line">    staticDir: path.resolve(__dirname, <span class="string">'./dist'</span>),</span><br><span class="line">    indexPath: path.resolve(__dirname, <span class="string">`./dist<span class="subst">$&#123;config.output.publicPath&#125;</span>index.html`</span>),</span><br><span class="line">    <span class="comment">// Required - Routes to render.</span></span><br><span class="line">    routes: [<span class="string">'/device/demo/add'</span>],</span><br><span class="line">    renderer: <span class="keyword">new</span> Renderer(&#123;</span><br><span class="line">        renderAfterDocumentEvent: <span class="string">'render-event'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>åœ¨ä½ æŒ‚è½½çš„mountedé’©å­è§¦å‘<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mounted () &#123;</span><br><span class="line">    <span class="built_in">document</span>.dispatchEvent(<span class="keyword">new</span> Event(<span class="string">'render-event'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æè‡´é¢„æ¸²æŸ“ï¼Œå°±æ˜¯è®©scriptèµ„æºä¸å½±å“æµè§ˆå™¨æ¸²æŸ“"><a href="#æè‡´é¢„æ¸²æŸ“ï¼Œå°±æ˜¯è®©scriptèµ„æºä¸å½±å“æµè§ˆå™¨æ¸²æŸ“" class="headerlink" title="æè‡´é¢„æ¸²æŸ“ï¼Œå°±æ˜¯è®©scriptèµ„æºä¸å½±å“æµè§ˆå™¨æ¸²æŸ“"></a>æè‡´é¢„æ¸²æŸ“ï¼Œå°±æ˜¯è®©scriptèµ„æºä¸å½±å“æµè§ˆå™¨æ¸²æŸ“</h3><blockquote><p>å…ˆæ¸²æŸ“å®Œå…ƒç´ ï¼Œå†æŒ‰é¡ºåºåŠ è½½jsèµ„æº <a href="https://github.com/youzan/tiny-loader.js" target="_blank" rel="noopener">tiny-loader</a></p></blockquote><p>å®‰è£… jsdom å·¥å…·<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D cheerio</span><br></pre></td></tr></table></figure></p><p>åœ¨ PrerenderSPAPlugin æ’ä»¶é…ç½®postProcessé’©å­<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">config.plugins.push(<span class="keyword">new</span> PrerenderSPAPlugin(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    postProcess (renderedRoute) &#123;</span><br><span class="line">        <span class="keyword">const</span> $ = cheerio.load(renderedRoute.html);</span><br><span class="line">        <span class="keyword">const</span> jsSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">        <span class="comment">// å…ˆæŠŠé¡µé¢çš„scriptè„šæœ¬åœ°å€æå–å¹¶ç”¨setå»é‡</span></span><br><span class="line">        $(<span class="string">'script'</span>).each(<span class="function">(<span class="params">index, s</span>) =&gt;</span> jsSet.add(s.attribs.src));</span><br><span class="line">        <span class="comment">// è¿‡æ»¤null</span></span><br><span class="line">        <span class="keyword">const</span> jsPaths = [ ...jsSet ].filter(<span class="function"><span class="params">s</span> =&gt;</span> !!s);</span><br><span class="line">        <span class="keyword">const</span> js = <span class="string">`</span></span><br><span class="line"><span class="string">            Loader.sync(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(jsPaths)&#125;</span>);</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        <span class="comment">// åˆ é™¤scriptæ ‡ç­¾</span></span><br><span class="line">        $(<span class="string">'script'</span>).remove();</span><br><span class="line">        <span class="comment">// æŠŠjsæ¤å…¥é¡µé¢</span></span><br><span class="line">        $(<span class="string">`&lt;script type="text/javascript"&gt;<span class="subst">$&#123;js&#125;</span>&lt;/script&gt;`</span>).insertAfter(<span class="string">'body'</span>);</span><br><span class="line">        <span class="comment">// æŠŠtiny-loader.jsæ¤å…¥é¡µé¢</span></span><br><span class="line">        $(<span class="string">`&lt;script src="<span class="subst">$&#123;config.output.publicPath&#125;</span>tiny-loader.js" type="text/javascript"&gt;&lt;/script&gt;`</span>).insertAfter(<span class="string">'body'</span>);</span><br><span class="line">        renderedRoute.html = $.html();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> renderedRoute;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p><h3 id="kubernetes-ingress-nginx-å®¹å™¨è·¯ç”±ï¼Œå¯¼è‡´ä¸¢å¤±publicPath"><a href="#kubernetes-ingress-nginx-å®¹å™¨è·¯ç”±ï¼Œå¯¼è‡´ä¸¢å¤±publicPath" class="headerlink" title="kubernetes ingress nginx å®¹å™¨è·¯ç”±ï¼Œå¯¼è‡´ä¸¢å¤±publicPath"></a>kubernetes ingress nginx å®¹å™¨è·¯ç”±ï¼Œå¯¼è‡´ä¸¢å¤±publicPath</h3><blockquote><p>è®¿é—®è·¯å¾„å¦‚æœä¸ä¸º<code>/</code>ç»“å°¾ï¼Œå¹¶ä¸”è®¿é—®çš„ä¸ºç›®å½•ï¼ˆå½“ä¸åšé¢„æ¸²æŸ“çš„æ—¶å€™ä¸ä¼šç”Ÿæˆè·¯ç”±å¯¹åº”çš„ç›®å½•ä¸htmlåˆ™ä¸ä¼šæœ‰é—®é¢˜ï¼‰nginxåˆ™ä¼šé‡å®šå‘åˆ°<code>/</code>ç»“å°¾ï¼Œä¼šå¯¼è‡´<br>å†…éƒ¨é‡å®šå‘æ—¶è·³å‡ºå®¹å™¨nginxä»è€Œä¸¢å¤±publicPathã€‚</p></blockquote><p>ä¿®æ”¹å®¹å™¨çš„nginxé…ç½®<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  root   /usr/vue/device/dist/;</span><br><span class="line">  if (-d $request_filename) &#123;</span><br><span class="line">    rewrite ^/(.*)([^/])$ $scheme://$host/device/$1$2/ permanent;</span><br><span class="line">  &#125;</span><br><span class="line">  index  index.html index.htm;</span><br><span class="line">  try_files $uri $uri/ /index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­<code>device</code>å°±æ˜¯publicPath</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://segmentfault.com/a/1190000004292479" target="_blank" rel="noopener">æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶</a></li><li>[2] <a href="https://segmentfault.com/a/1190000018182165?utm_source=tag-newest" target="_blank" rel="noopener">å‰ç«¯prerender-spa-pluginé¢„æ¸²æŸ“</a></li><li>[3] <a href="https://www.cnblogs.com/z-books/p/12410840.html" target="_blank" rel="noopener">nginxä¸‹URLæœ«å°¾è‡ªåŠ¨åŠ æ–œæ </a></li></ul>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> vue </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
            <tag> é¢„æ¸²æŸ“ </tag>
            
            <tag> prerender-spa-plugin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ¶ä½œè‡ªå·±çš„npmåŒ…å¹¶æ’é™¤ç¬¬ä¸‰æ–¹ä¾èµ–</title>
      <link href="/2020/06/12/%E5%88%B6%E4%BD%9C%E8%87%AA%E5%B7%B1%E7%9A%84npm%E5%8C%85%E5%B9%B6%E6%8E%92%E9%99%A4%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96/"/>
      <url>/2020/06/12/%E5%88%B6%E4%BD%9C%E8%87%AA%E5%B7%B1%E7%9A%84npm%E5%8C%85%E5%B9%B6%E6%8E%92%E9%99%A4%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ç¬¬ä¸‰æ–¹åŒ…æ‰€æä¾›çš„åŠŸèƒ½æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚çš„æ—¶å€™ï¼Œæˆ–è€…å…¬å¸å…¬å…±ç»„ä»¶ã€‚æˆ‘ä»¬éœ€è¦åˆ¶ä½œè‡ªå·±çš„npmåŒ…ã€‚</p><h3 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h3><ol><li>åœ¨<code>npmjs.org</code>æ³¨å†Œè´¦æˆ·ï¼ˆå…¬å¸ç§æœåˆ™éœ€è¦è¿ç»´å¼€è´¦æˆ·ï¼‰ã€‚</li><li>æ£€æŸ¥æœ¬åœ°<code>npm config registry</code>æ˜¯å¦ä¸º<code>npmjs.org</code>æˆ–è€…å…¬å¸ç§æœåœ°å€ã€‚</li><li>æœ¬åœ°npmç™»å½•<code>npm login</code>è¾“å…¥è´¦æˆ·/å¯†ç ã€‚ç„¶åä¼šè®©ä½ è¾“å…¥é‚®ç®±åœ°å€ï¼Œè¿™ä¸ªä¸ºnpmjsä¸Šé…ç½®çš„é‚®ä»¶åœ°å€ã€‚</li></ol><h3 id="ç¼–è¯‘npmé¡¹ç›®"><a href="#ç¼–è¯‘npmé¡¹ç›®" class="headerlink" title="ç¼–è¯‘npmé¡¹ç›®"></a>ç¼–è¯‘npmé¡¹ç›®</h3><blockquote><p>å¯å‚è€ƒæ­¤é¡¹ç›® <a href="https://github.com/zhouxianjun/muse-ui-fabric" target="_blank" rel="noopener">https://github.com/zhouxianjun/muse-ui-fabric</a></p></blockquote><ol><li>ä½¿ç”¨vue cli3 åˆ›å»ºé¡¹ç›®ã€‚</li><li>å¦‚æœç»„ä»¶ä¸­æœ‰ä½¿ç”¨åˆ°ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…å¹¶ä¸”ä¸æƒ³ç¼–è¯‘åœ¨è‡ªå·±çš„ç»„ä»¶ä¸­ï¼Œåˆ™éœ€è¦é…ç½®vue.config.js externals<blockquote><p>æˆ‘è¿™é‡Œåªæ˜¯åšäº†ä¸€ä¸ªä¾‹å­ï¼Œå®é™…æƒ…å†µçœ‹ä½ æœ‰å“ªäº›ç¬¬ä¸‰æ–¹ä¾èµ–ä¸æƒ³ç¼–è¯‘åˆ™è‡ªè¡Œé…ç½®</p></blockquote></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    chainWebpack: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'production'</span>) &#123;</span><br><span class="line">          config.externals(&#123;</span><br><span class="line">                <span class="string">'lodash'</span>: &#123;</span><br><span class="line">                    commonjs: <span class="string">"lodash"</span>,<span class="comment">//å¦‚æœæˆ‘ä»¬çš„åº“è¿è¡Œåœ¨Node.jsç¯å¢ƒä¸­ï¼Œimport _ from 'lodash'ç­‰ä»·äºconst _ = require('lodash')</span></span><br><span class="line">                    commonjs2: <span class="string">"lodash"</span>,<span class="comment">//åŒä¸Š</span></span><br><span class="line">                    amd: <span class="string">"lodash"</span>,<span class="comment">//å¦‚æœæˆ‘ä»¬çš„åº“ä½¿ç”¨require.jsç­‰åŠ è½½,ç­‰ä»·äº define(["lodash"], factory);</span></span><br><span class="line">                    root: <span class="string">"_"</span> <span class="comment">// è¿™ä¸ªä¸ºlodashæš´éœ²çš„å˜é‡</span></span><br><span class="line">                &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>åœ¨æ–°å»ºçš„é¡¹ç›®ä¸­çš„components ç›®å½•ä¸‹çš„æ–‡ä»¶å…¨éƒ¨åˆ é™¤ï¼ˆéœ€è¦å…ˆæŠŠå¼•ç”¨åˆ°çš„åœ°æ–¹åˆ é™¤ï¼‰ï¼Œç„¶åæŠŠä½ çš„ä»£ç å†™åœ¨é‡Œé¢ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸æ”¾åœ¨componentsä¸­ï¼Œåªæ˜¯æˆ‘å–œæ¬¢æ”¾åœ¨è¿™é‡Œï¼‰ã€‚</li><li>è‡ªå·±å¯ä»¥åœ¨App.vueä¸­å¼•ç”¨è‡ªå·±çš„ç»„ä»¶æµ‹è¯•ã€‚</li><li>æµ‹é€šè¿‡åä½¿ç”¨vue cli æ‰“åŒ…<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue-cli-service build --mode production --target lib ./src/components/index.js</span><br></pre></td></tr></table></figure></li></ol><h3 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h3><ol><li>åœ¨<code>package.json</code>ä¸­æŠŠprivateä¿®æ”¹ä¸ºfalseï¼ˆå¦‚æœä½ ä¹°äº†ç§æœ‰ä»“åº“å°±ä¸ç”¨æ”¹ï¼‰ã€‚</li><li>åœ¨<code>package.json</code>æ–°å¢æˆ–ä¿®æ”¹<code>main</code>å­—æ®µä¸ºï¼š<code>dist/ä½ çš„é¡¹ç›®åç§°.umd.min.js</code>ã€‚</li><li><p>å‘å¸ƒåˆ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœä¿®æ”¹äº†ä»£ç æƒ³è¦é‡æ–°å‘å¸ƒï¼Œåˆ™å¿…é¡»å…ˆæŠŠ<code>package.json</code>ä¸­çš„ç‰ˆæœ¬å·<code>version</code>è‡ªè¡Œä¿®æ”¹ã€‚</p></li><li>å‘å¸ƒåï¼Œå¯ä»¥å†æ–°å»ºä¸€ä¸ªç©ºçš„vueé¡¹ç›®ï¼Œç›´æ¥å¼•ç”¨ä½ åˆšæ‰å‘å¸ƒçš„ç»„ä»¶ï¼Œå¦‚æœä½ ç»„ä»¶ä¸­æœ‰ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œåˆ™npmä¼šè‡ªåŠ¨ä¸‹è½½æ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–ï¼Œ<br>å¦‚æœåœ¨ä½¿ç”¨é¡¹ç›®ä¸­ä¸æƒ³è®©ç»„ä»¶ä¸­çš„ä¾èµ–ç¼–è¯‘åˆ°chunk-vendorsæ–‡ä»¶ä¸­ï¼Œåˆ™å¯ä»¥åœ¨ä½¿ç”¨é¡¹ç›®ä¸­é…ç½®externalsï¼Œä¾‹å¦‚ï¼š<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    chainWebpack: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">          config.externals(&#123;</span><br><span class="line">                <span class="string">'lodash'</span>: <span class="string">'_'</span></span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>å¥½äº†ï¼Œä»Šå¤©å°±è®²åˆ°è¿™é‡Œï¼Œå¦‚æœ‰åŒå­¦éœ€è¦æŸ¥çœ‹åˆ†æåŒ…å†…å®¹åˆ™å¯ä»¥ä½¿ç”¨<code>vue ui</code>åœ¨ä»»åŠ¡ä¸­è¿è¡Œä¸€ä¸ªtaskç„¶åç‚¹å‡»åˆ†æï¼Œå°±å¯ä»¥åˆ†ææ¯ä¸ªæ‰“åŒ…åçš„jsç”±å“ªäº›ç»„æˆäº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> npm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> npm </tag>
            
            <tag> npmjs </tag>
            
            <tag> åˆ¶ä½œnpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring boot JDBCåŠ¨æ€æ•°æ®æº starter</title>
      <link href="/2019/09/17/Spring-boot-JDBC%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90-starter/"/>
      <url>/2019/09/17/Spring-boot-JDBC%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90-starter/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šå†…éƒ¨çš„é¡¹ç›®éƒ½æ˜¯ç›´æ¥è®¿é—®å¤šä¸ªæ•°æ®åº“ï¼Œè¿™æ ·å¹³æ—¶ä¸€ä¸ªé¡¹ç›®ä¸€ä¸ªæ•°æ®åº“å°±ä¸å¤Ÿç”¨äº†ï¼Œspringæ”¯æŒå¤šæ•°æ®æºã€‚<br>ç°åœ¨å¾ˆæµè¡ŒSpring bootè‡ªåŠ¨é…ç½®ï¼Œæˆ‘åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸ªåŸºäºSpring boot starteræ–¹å¼çš„å¤šæ•°æ®æºï¼ˆåŠ¨æ€è‡ªåŠ¨åˆ‡æ¢ï¼‰æ•´åˆæ–¹æ¡ˆã€‚</p><p>ç”±äºæˆ‘ä»¬éœ€è¦åšä¸€ä¸ªstarterï¼Œæ‰€ä»¥æˆ‘ä»¬å‚ç…§mybatis-spring-boot-startçš„æ–¹å¼æ–°å»ºä¸¤ä¸ªå·¥ç¨‹ï¼š</p><h3 id="1ã€åˆ›å»º-dynamic-datasource-spring-boot-autoconfigure"><a href="#1ã€åˆ›å»º-dynamic-datasource-spring-boot-autoconfigure" class="headerlink" title="1ã€åˆ›å»º dynamic-datasource-spring-boot-autoconfigure"></a>1ã€åˆ›å»º dynamic-datasource-spring-boot-autoconfigure</h3><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alone<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dynamic-datasource-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>dynamic datasource auto configure<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ˜¯ä¸€ä¸ªspring booté¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ç»§æ‰¿spring bootçš„parentï¼Œç„¶åä¾èµ–spring-boot-starterï¼Œ<br>å’Œjdbc starterï¼ˆæ•°æ®æºï¼‰ã€aop starterï¼ˆåˆ‡é¢æ‹¦æˆªè‡ªåŠ¨åˆ‡æ¢æ•°æ®æºï¼‰ã€configuration-processorï¼ˆä¸ºäº†æŠŠå®ä½“ç±»çš„å±æ€§åœ¨propertiesä¸­é…ç½®çš„æ—¶å€™å¯ä»¥æç¤ºï¼‰</p><h4 id="DynamicDataSourceProperties-é…ç½®ç±»"><a href="#DynamicDataSourceProperties-é…ç½®ç±»" class="headerlink" title="DynamicDataSourceProperties é…ç½®ç±»"></a>DynamicDataSourceProperties é…ç½®ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"dynamic.ds"</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceProperties</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®æºmap</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, DataSourceProperties&gt; datasource;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤æ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String defaultDataSource;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœªæ‰¾åˆ°æŒ‡å®šæ•°æ®æºæ˜¯å¦ä½¿ç”¨é»˜è®¤æ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Boolean notFoundUseDefault = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">haveDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> defaultDataSource != <span class="keyword">null</span> &amp;&amp; datasource.containsKey(defaultDataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> datasource.containsKey(name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰é…ç½®å±æ€§è‡ªåŠ¨é…ç½®ç±»ï¼Œå‰ç¼€ä¸º<code>dynamic.ds</code>, ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬è¿™é‡Œæ•°æ®æºçš„é…ç½®ç›´æ¥ä½¿ç”¨çš„æ˜¯Springä¸­çš„<code>DataSourceProperties</code>ï¼Œæˆ‘ä»¬é…ç½®ç±»ä¸­ä¸»è¦çš„åˆ†ä¸ºï¼š</p><p>1ã€datasource é…ç½®å¤šä¸ªæ•°æ®æºä»¥Key-Valueå½¢å¼ï¼Œkeyä¸ºæ•°æ®æºåç§°ï¼ŒValueä¸º<code>DataSourceProperties</code>ï¼Œä¾‹å¦‚:dynamic.ds.datasource.xxx.url å…¶ä¸­çš„xxxä¸ºkeyï¼Œurlä¸ºDataSourcePropertiesä¸­çš„å±æ€§</p><p>2ã€defaultDataSource é»˜è®¤æ•°æ®æºï¼Œå¦‚æœé…ç½®äº†<code>spring.datasource.xxx</code>åˆ™ä½¿ç”¨è¯¥æ•°æ®æºä¸ºé»˜è®¤æ•°æ®æºã€‚</p><p>3ã€notFoundUseDefault æœªæ‰¾åˆ°æŒ‡å®šæ•°æ®æºæ˜¯å¦ä½¿ç”¨é»˜è®¤æ•°æ®æºï¼Œå¦‚æœä½¿ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨ï¼ˆæ²¡æœ‰åœ¨ç¬¬1ç‚¹ä¸­é…ç½®çš„ï¼‰çš„æ•°æ®æºï¼Œæ˜¯å¦ä½¿ç”¨é»˜è®¤æ•°æ®æºã€‚</p><p>@Data è¿™ä¸ªæ³¨è§£ä¸ºlombokä¸­çš„ï¼Œä¸»è¦æ˜¯è‡ªåŠ¨ç”Ÿæˆå±æ€§çš„setterå’Œgetterã€‚@ConfigurationProperties ä¸ºspringä¸­çš„å±æ€§é…ç½®æ³¨è§£ï¼Œä¼šè‡ªåŠ¨æŠŠpropertiesä¸­ç›¸åŒ¹é…çš„å±æ€§æ³¨å…¥ã€‚</p><h4 id="DynamicDataSource-ç»§æ‰¿-AbstractRoutingDataSource"><a href="#DynamicDataSource-ç»§æ‰¿-AbstractRoutingDataSource" class="headerlink" title="DynamicDataSource ç»§æ‰¿ AbstractRoutingDataSource"></a>DynamicDataSource ç»§æ‰¿ AbstractRoutingDataSource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// è¿”å›å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å€¼</span></span><br><span class="line"><span class="keyword">return</span> DynamicDataSourceContextHolder.get();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring JDBC åŒ…ä¸­æœ‰ä¸€ä¸ª<code>AbstractRoutingDataSource</code>ç±»ï¼Œè¯¥ç±»ä¸ºæ•°æ®æºçš„è·¯ç”±æŠ½è±¡ç±»ï¼Œ<br>æˆ‘ä»¬è¿™é‡Œä¸»è¦ä½¿ç”¨<code>determineCurrentLookupKey</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ•°æ®æºåç§°å³å¯ã€‚</p><h4 id="DynamicDataSourceAutoConfiguration-è‡ªåŠ¨åˆå§‹åŒ–é…ç½®"><a href="#DynamicDataSourceAutoConfiguration-è‡ªåŠ¨åˆå§‹åŒ–é…ç½®" class="headerlink" title="DynamicDataSourceAutoConfiguration è‡ªåŠ¨åˆå§‹åŒ–é…ç½®"></a>DynamicDataSourceAutoConfiguration è‡ªåŠ¨åˆå§‹åŒ–é…ç½®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(DataSource<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">DynamicDataSourceProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureBefore</span>(<span class="title">DataSourceAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(<span class="title">DynamicDataSourceAop</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">DynamicDataSourceAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DynamicDataSourceProperties properties;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¶å®ƒæ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Object, Object&gt; dataSources;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤æ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> DataSource defaultDateSource;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicDataSourceAutoConfiguration</span><span class="params">(DynamicDataSourceProperties properties)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.properties = properties;</span><br><span class="line"><span class="keyword">this</span>.dataSources = properties.getDatasource().entrySet().stream().collect(</span><br><span class="line">Collectors.toMap(Map.Entry::getKey, entry -&gt; entry.getValue().initializeDataSourceBuilder().build())</span><br><span class="line">);</span><br><span class="line">Assert.notEmpty(properties.getDatasource(), <span class="string">"è¯·é…ç½®åŠ¨æ€æ•°æ®æº"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">DynamicDataSource dataSource = <span class="keyword">new</span> DynamicDataSource();</span><br><span class="line">dataSource.setTargetDataSources(<span class="keyword">this</span>.dataSources);</span><br><span class="line">dataSource.setDefaultTargetDataSource(defaultDateSource);</span><br><span class="line"><span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!properties.haveDefault()) &#123;</span><br><span class="line"><span class="keyword">if</span> (hasPrefix(environment, <span class="string">"spring.datasource"</span>)) &#123;</span><br><span class="line">Binder binder = Binder.get(environment);</span><br><span class="line">defaultDateSource = binder</span><br><span class="line">.bind(<span class="string">"spring.datasource"</span>, DataSourceProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">.<span class="title">get</span>()</span></span><br><span class="line"><span class="class">.<span class="title">initializeDataSourceBuilder</span>()</span></span><br><span class="line"><span class="class">.<span class="title">build</span>()</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">int</span> size = dataSources.size();</span><br><span class="line">Assert.isTrue(size &lt;= <span class="number">1</span>, <span class="string">"å½“å‰æ•°æ®æºä¸­æœ‰å¤šä¸ªï¼Œä½†æ²¡æœ‰æŒ‡å®šé»˜è®¤æ•°æ®æº."</span>);</span><br><span class="line">defaultDateSource = (DataSource) dataSources.values().iterator().next();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">defaultDateSource = (DataSource) dataSources.get(properties.getDefaultDataSource());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasPrefix</span><span class="params">(Environment environment, String prefix)</span> </span>&#123;</span><br><span class="line">AbstractEnvironment env = (AbstractEnvironment) environment;</span><br><span class="line"><span class="keyword">return</span> env.getPropertySources().stream().filter(p -&gt; p <span class="keyword">instanceof</span> MapPropertySource)</span><br><span class="line">.anyMatch((p) -&gt; ((MapPropertySource) p).getSource().keySet().stream()</span><br><span class="line">.anyMatch(k -&gt; k.startsWith(prefix)));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@Configuration æ³¨è§£ï¼Œå‘Šè¯‰springè¯¥ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œ@ConditionalOnClass(DataSource.class) è¡¨ç¤ºåœ¨å«æœ‰DataSourceè¿™ä¸ªç±»çš„æƒ…å†µä¸‹æœ‰æ•ˆã€‚<br>@EnableConfigurationProperties å¯ç”¨å±æ€§é…ç½®ï¼Œ@AutoConfigureBefore è¡¨ç¤ºåœ¨æŸä¸ªç±»åˆå§‹åŒ–ä¹‹å‰ï¼Œè¿™é‡Œä¸ºDataSourceAutoConfigurationã€‚<br>@Import å¯¼å…¥å…¶ä»–éœ€è¦é…ç½®çš„ç±»ã€‚<br>è¯¥ç±»å®ç°äº†EnvironmentAwareæ¥å£ï¼Œç”¨äºè·å–ç”¨æˆ·æ˜¯å¦æœ‰é…ç½®spring.datasourceå‰ç¼€çš„å±æ€§ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰é…ç½®é»˜è®¤æ•°æ®æºï¼Œå¹¶ä¸”é…ç½®äº†spring.datasourceåˆ™ä½¿ç”¨è¯¥æ•°æ®æºä¸ºé»˜è®¤æ•°æ®æºã€‚<br>æ„é€ å‡½æ•°å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯æŠŠé…ç½®çš„æ•°æ®æºåˆå§‹åŒ–ï¼Œæ²¡ä»€ä¹ˆå¯ä»¥è®²çš„ã€‚<br>ç„¶åä½¿ç”¨@Beanæ³¨è§£æš´éœ²äº†ä¸€ä¸ªDataSourceï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„DynamicDataSourceï¼Œè¿™é‡Œä¸»è¦æ˜¯æŠŠæˆ‘ä»¬çš„åŠ¨æ€æ•°æ®æºæ”¾å…¥springå®¹å™¨ï¼Œå¹¶è®¾ç½®æ•°æ®æºé›†åˆä»¥åŠé»˜è®¤æ•°æ®æºï¼Œè¿™æ ·åœ¨springçš„jdbcæµç¨‹ä¸­å¯ä»¥ç›´æ¥è·å–åˆ°è¯¥æ•°æ®æºã€‚</p><h4 id="DynamicDataSourceContextHolder"><a href="#DynamicDataSourceContextHolder" class="headerlink" title="DynamicDataSourceContextHolder"></a>DynamicDataSourceContextHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceContextHolder</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; HOLDER = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">HOLDER.set(type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> HOLDER.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">HOLDER.remove();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯åˆ©ç”¨ThreadLocalçš„ç‰¹æ€§ï¼ŒæŠŠæ•°æ®æºæ ‡ç¤ºä¿å­˜åœ¨å½“å‰çº¿ç¨‹ä¸­ï¼Œé¿å…å¤šçº¿ç¨‹æ“ä½œæ•°æ®æºæ—¶äº’ç›¸å¹²æ‰°ã€‚</p><h4 id="TargetDataSource-æ³¨è§£"><a href="#TargetDataSource-æ³¨è§£" class="headerlink" title="TargetDataSource æ³¨è§£"></a>TargetDataSource æ³¨è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123; ElementType.METHOD, ElementType.TYPE &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TargetDataSource &#123;</span><br><span class="line"><span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ³¨è§£ä¸»è¦æ˜¯é…åˆaopåˆ‡é¢è‡ªåŠ¨åˆ‡æ¢æ•°æ®æºä½¿ç”¨çš„ï¼Œå’Œ@TransactionåŒç†ã€‚</p><h4 id="DynamicDataSourceAop-åŠ¨æ€æ•°æ®æºåˆ‡é¢"><a href="#DynamicDataSourceAop-åŠ¨æ€æ•°æ®æºåˆ‡é¢" class="headerlink" title="DynamicDataSourceAop åŠ¨æ€æ•°æ®æºåˆ‡é¢"></a>DynamicDataSourceAop åŠ¨æ€æ•°æ®æºåˆ‡é¢</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order</span>(-<span class="number">1</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceAop</span> </span>&#123;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DynamicDataSourceProperties properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around</span>(<span class="string">"@annotation(source)"</span>)</span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">method</span><span class="params">(ProceedingJoinPoint joinPoint, TargetDataSource source)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> around(joinPoint, source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around</span>(<span class="string">"@within(source)"</span>)</span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">targetClass</span><span class="params">(ProceedingJoinPoint joinPoint, TargetDataSource source)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> around(joinPoint, source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint, TargetDataSource source)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">String name = source.value();</span><br><span class="line"><span class="keyword">if</span> (!properties.has(name)) &#123;</span><br><span class="line">Assert.isTrue(properties.getNotFoundUseDefault(), <span class="string">"æŒ‡å®šçš„æ•°æ®æº: "</span> + name + <span class="string">" æœªé…ç½®ï¼Œå¹¶ notFoundUseDefault is false."</span>);</span><br><span class="line">log.warn(<span class="string">"æŒ‡å®šçš„æ•°æ®æº: &#123;&#125; æœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®æº."</span>, name);</span><br><span class="line"><span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">&#125;</span><br><span class="line">DynamicDataSourceContextHolder.set(name);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">DynamicDataSourceContextHolder.clear();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"dynamic datasource aop init ok."</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„@Orderå¿…é¡»è¦æ¯”springäº‹åŠ¡çš„orderè¦å°ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥åˆ‡é¢å¿…é¡»æ¯”springçš„äº‹åŠ¡å…ˆæ‰§è¡Œï¼Œå¦åˆ™æ— æ•ˆã€‚<br>æˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ª@Aroundç¯ç»•é€šçŸ¥ï¼Œä¸€ä¸ªæ‹¦æˆªæ–¹æ³•ä¸Šå«æœ‰TargetDataSourceæ³¨è§£çš„ï¼Œå¦ä¸€ä¸ªæ‹¦æˆªæ–¹æ³•çš„ç›®æ ‡ç±»ä¸Šå«æœ‰TargetDataSourceæ³¨è§£çš„ã€‚<br>åœ¨è°ƒç”¨ç›®æ ‡æ–¹æ³•ä¹‹å‰æŠŠéœ€è¦çš„æ•°æ®æºæ ‡ç¤ºä¿å­˜åˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œç„¶åæ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‚æœ€ååˆ«å¿˜è®°è¦æŠŠå½“å‰çº¿ç¨‹æ¸…ç©ºï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p><p>å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„åŠ¨æ€æ•°æ®æºçš„é…ç½®ç±»å°±å·²ç»å†™å®Œäº†ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™springå¹¶ä¸è®¤è¯†æˆ‘ä»¬ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‘Šè¯‰å®ƒï¼š<br>åœ¨resourceç›®å½•æ–°å»ºMETA-INFç›®å½•å¹¶ä¸”æ–°å»ºspring.factoriesæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">com.alone.spring.boot.autoconfigure.dynamic.datasource.DynamicDataSourceAutoConfiguration</span><br></pre></td></tr></table></figure></p><p>å‘Šè¯‰springæˆ‘ä»¬çš„DynamicDataSourceAutoConfigurationç±»ä¸ºè‡ªåŠ¨é…ç½®ç±»ã€‚</p><h3 id="2ã€åˆ›å»º-dynamic-datasource-spring-boot-starter"><a href="#2ã€åˆ›å»º-dynamic-datasource-spring-boot-starter" class="headerlink" title="2ã€åˆ›å»º dynamic-datasource-spring-boot-starter"></a>2ã€åˆ›å»º dynamic-datasource-spring-boot-starter</h3><p>è¿™ä¸ªå·¥ç¨‹å¯è¦å¯ä¸è¦ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æŒ‰ç…§spring boot starterçš„è§„èŒƒï¼Œæ‰€ä»¥æ‰åˆ†ä¸ºäº†ä¸¤ä¸ªå·¥ç¨‹ï¼Œå¦‚æœä½ å«Œéº»çƒ¦å¯ä»¥ä¸è¦è¿™ä¸ªå·¥ç¨‹å³å¯ã€‚<br>è¯¥å·¥ç¨‹ä¸éœ€è¦resourceä»¥åŠclassç›®å½•ï¼Œåªéœ€è¦pomä¸­ä¾èµ–ç¬¬ä¸€æ­¥çš„å·¥ç¨‹å³å¯ï¼Œå¹¶ä¸”è¯¥å·¥ç¨‹ä¸éœ€è¦ç»§æ‰¿spring boot parentã€‚</p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><h4 id="æ–°å»ºæµ‹è¯•å·¥ç¨‹-dynamic-datasource-demo"><a href="#æ–°å»ºæµ‹è¯•å·¥ç¨‹-dynamic-datasource-demo" class="headerlink" title="æ–°å»ºæµ‹è¯•å·¥ç¨‹ dynamic-datasource-demo"></a>æ–°å»ºæµ‹è¯•å·¥ç¨‹ dynamic-datasource-demo</h4><h4 id="pom-xml-1"><a href="#pom-xml-1" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alone<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-datasource-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dynamic-datasource-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alone<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.46<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¾èµ–ï¼Œæˆ‘ä»¬çš„dynamic-datasource-spring-boot-starterï¼Œå¹¶ä¸”ä¾èµ–æ•°æ®é©±åŠ¨åŒ…ï¼Œæˆ‘è¿™é‡Œç”¨çš„mysqlã€‚</p><h4 id="åˆ›å»º-æµ‹è¯•æœåŠ¡-DemoService"><a href="#åˆ›å»º-æµ‹è¯•æœåŠ¡-DemoService" class="headerlink" title="åˆ›å»º æµ‹è¯•æœåŠ¡ DemoService"></a>åˆ›å»º æµ‹è¯•æœåŠ¡ DemoService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defaultMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.println(jdbcTemplate.queryForList(<span class="string">"select * from t_order"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TargetDataSource</span>(<span class="string">"other"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">other</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.println(jdbcTemplate.queryForList(<span class="string">"select * from tab_flow"</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ª defaultMethod ä¸ºé»˜è®¤æ•°æ®æºï¼Œç¬¬äºŒä¸ªæˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†@TargetDataSourceæ³¨è§£å¹¶ä¸”èµ‹å€¼ä¸ºotheræ•°æ®æºã€‚</p><h4 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dynamic.ds.datasource.other.url = jdbc:mysql://url/other?characterEncoding=utf8&amp;useSSL=false&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;allowMultiQueries=true</span><br><span class="line">dynamic.ds.datasource.other.username = root</span><br><span class="line">dynamic.ds.datasource.other.password = xxx</span><br><span class="line">dynamic.ds.datasource.other.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line"></span><br><span class="line">spring.datasource.url = jdbc:mysql://url/default?characterEncoding=utf8&amp;useSSL=false&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;allowMultiQueries=true </span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = xxx</span><br><span class="line">spring.datasource.driver-class-name = com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure><p>å¤§åŠŸå‘Šæˆã€‚</p><p>å…¨éƒ¨ä»£ç åœ¨Githubï¼š <a href="https://github.com/zhouxianjun/dynamic-datasource-spring-boot-starter" target="_blank" rel="noopener">dynamic-datasource-spring-boot-starter</a>ã€<a href="https://github.com/zhouxianjun/dynamic-datasource-spring-boot-autoconfigure" target="_blank" rel="noopener">dynamic-datasource-spring-boot-autoconfigure</a>,<br>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨jitpackæºï¼š<a href="https://jitpack.io/#zhouxianjun/dynamic-datasource-spring-boot-starter" target="_blank" rel="noopener"><img src="https://jitpack.io/v/zhouxianjun/dynamic-datasource-spring-boot-starter.svg" alt></a>ï¼Œå¦‚æœä½ ä½¿ç”¨äº†ç§æœä»“åº“è¯·é…ç½®ä½ çš„setting.xmlä¸­çš„mirrorOfä¸ºï¼š<code>*,!jitpack.io</code></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
          <category> Java </category>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring boot </tag>
            
            <tag> starter </tag>
            
            <tag> jdbc </tag>
            
            <tag> åŠ¨æ€æ•°æ®æº </tag>
            
            <tag> å¤šæ•°æ®æº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç”¨muse ui + fabricjsåšæµ·æŠ¥ç¼–è¾‘å™¨</title>
      <link href="/2019/05/01/%E7%94%A8muse-ui-+-fabricjs%E5%81%9A%E6%B5%B7%E6%8A%A5%E7%BC%96%E8%BE%91%E5%99%A8/"/>
      <url>/2019/05/01/%E7%94%A8muse-ui-+-fabricjs%E5%81%9A%E6%B5%B7%E6%8A%A5%E7%BC%96%E8%BE%91%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="åŠŸèƒ½ç‚¹"><a href="#åŠŸèƒ½ç‚¹" class="headerlink" title="åŠŸèƒ½ç‚¹"></a>åŠŸèƒ½ç‚¹</h2><h3 id="æ·»åŠ å›¾ç‰‡"><a href="#æ·»åŠ å›¾ç‰‡" class="headerlink" title="æ·»åŠ å›¾ç‰‡"></a>æ·»åŠ å›¾ç‰‡</h3><blockquote><p>ç”±äºç”»æ¿ä¸Šä¼šæœ‰å¾ˆå¤šå›¾ç‰‡å…ƒç´ ï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªå…ƒç´ è®¾ç½®ä¸åŒå¯¹åœ†è§’ä»¥åŠé€æ˜åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ·»åŠ å›¾ç‰‡çš„æ—¶å€™ç»™å½“å‰å…ƒç´ ç”Ÿæˆä¸€ä¸ªå”¯ä¸€IDæ¥æ ‡ç¤ºå®ƒï¼Œå¹¶ä¸”æŠŠå®ƒçš„æ‰€æœ‰é…ç½®å±æ€§å­˜å‚¨ã€‚</p></blockquote><h4 id="å›¾ç‰‡æº"><a href="#å›¾ç‰‡æº" class="headerlink" title="å›¾ç‰‡æº"></a>å›¾ç‰‡æº</h4><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param </span>url å›¾ç‰‡æ•°æ®ï¼šæœ¬åœ°åœ°å€ã€è¿œç¨‹åœ°å€ã€base64</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param </span>options å›¾ç‰‡é…ç½®ï¼šå…·ä½“è¯·æŸ¥çœ‹fabricå®˜ç½‘docï¼Œè¿™é‡Œæ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå›¾ç‰‡æºä¸ºè¿œç¨‹åœ°å€ï¼Œåˆ™éœ€è¦é…ç½®è·¨åŸŸè®¿é—®</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">async</span> loadImg (url, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        fabric.Image.fromURL(url, img =&gt; resolve(img), &#123;</span><br><span class="line">            ...this.optionsOfType(<span class="string">'image'</span>),</span><br><span class="line">            ...options</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åœ†è§’"><a href="#åœ†è§’" class="headerlink" title="åœ†è§’"></a>åœ†è§’</h4><blockquote><p>ä¸»è¦ä½¿ç”¨å›¾ç‰‡çš„<code>clipTo</code>çš„å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å½“å‰å‡½æ•°å¯¹å½“å‰å›¾ç‰‡ç”»åœ†<code>arc</code>.è¿™é‡Œå…¶å®å°±æ˜¯canvasçš„arcå‡½æ•°ã€‚<br><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx =&gt; ctx.arc(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.radius[img.id].val, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="é€æ˜åº¦"><a href="#é€æ˜åº¦" class="headerlink" title="é€æ˜åº¦"></a>é€æ˜åº¦</h4><blockquote><p>è¿™é‡Œåªè¦è®¾ç½®å½“å‰é€‰æ‹©å›¾ç‰‡çš„styleï¼ˆopacityï¼‰å³å¯ï¼Œç„¶åå†é‡æ–°renderç”»æ¿ã€‚<br><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">setActiveStyle (style) &#123;</span><br><span class="line">    <span class="keyword">const</span> object = <span class="keyword">this</span>.canvas.getActiveObject();</span><br><span class="line">    <span class="keyword">if</span> (!object) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (object.setSelectionStyles &amp;&amp; object.isEditing) &#123;</span><br><span class="line">        object.setSelectionStyles(style);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Reflect</span>.ownKeys(style).forEach(<span class="function"><span class="params">item</span> =&gt;</span> object.set(item, style[item]));</span><br><span class="line">    &#125;</span><br><span class="line">    object.setCoords();</span><br><span class="line">    <span class="keyword">this</span>.canvas.requestRenderAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="æ·»åŠ æ–‡å­—"><a href="#æ·»åŠ æ–‡å­—" class="headerlink" title="æ·»åŠ æ–‡å­—"></a>æ·»åŠ æ–‡å­—</h3><blockquote><p>è¿™é‡Œé‡‡ç”¨fabricçš„<code>IText</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ§ä»¶ã€‚<br><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">addText (content = <span class="string">'text'</span>, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> text = <span class="keyword">new</span> fabric.IText(content, <span class="built_in">Object</span>.assign(<span class="keyword">this</span>.optionsOfType(<span class="string">'i-text'</span>), &#123;</span><br><span class="line">        left: <span class="keyword">this</span>.canvas.width / <span class="number">2</span>,</span><br><span class="line">        top: <span class="keyword">this</span>.canvas.height / <span class="number">2</span>,</span><br><span class="line">        fill: <span class="string">'#000000'</span>,</span><br><span class="line">        scaleX: <span class="number">0.5</span>,</span><br><span class="line">        scaleY: <span class="number">0.5</span>,</span><br><span class="line">        hasRotatingPoint: <span class="literal">true</span></span><br><span class="line">    &#125;, options));</span><br><span class="line">    <span class="keyword">this</span>.addAndSelect(text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="é€æ˜"><a href="#é€æ˜" class="headerlink" title="é€æ˜"></a>é€æ˜</h4><blockquote><p>ä¸å›¾ç‰‡é€æ˜åº¦ä¸€æ ·ï¼Œè®¾ç½®<code>opacity</code>æ ·å¼å³å¯ã€‚</p></blockquote><h4 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h4><blockquote><p>éœ€è¦è®¾ç½®æ§ä»¶å±æ€§<code>fontFamily</code>ã€‚ç›®å‰å®ç°çš„å­—ä½“ï¼šâ€™Arialâ€™, â€˜Helveticaâ€™, â€˜å®‹ä½“â€™, â€˜é»‘ä½“â€™, â€˜å¾®è½¯é›…é»‘â€™, â€˜æ¥·ä½“â€™, â€˜ä»¿å®‹â€™, â€˜Verdanaâ€™, â€˜Times New Romanâ€™, â€˜Robotoâ€™, â€˜Open Sansâ€™, â€˜Latoâ€™, â€˜Bellefairâ€™, â€˜Frescaâ€™, â€˜Ralewayâ€™</p></blockquote><h4 id="å¤§å°"><a href="#å¤§å°" class="headerlink" title="å¤§å°"></a>å¤§å°</h4><blockquote><p>è®¾ç½®æ§ä»¶å±æ€§<code>fontSize</code></p></blockquote><h4 id="å¯¹é½æ–¹å¼"><a href="#å¯¹é½æ–¹å¼" class="headerlink" title="å¯¹é½æ–¹å¼"></a>å¯¹é½æ–¹å¼</h4><blockquote><p>è®¾ç½®æ§ä»¶å±æ€§<code>textAlign</code>:leftã€centerã€rightã€justify</p></blockquote><h4 id="é¢œè‰²"><a href="#é¢œè‰²" class="headerlink" title="é¢œè‰²"></a>é¢œè‰²</h4><blockquote><p>ä½¿ç”¨ç¬¬ä¸‰æ–¹é€‰æ‹©é¢œè‰²ç»„ä»¶ï¼š<code>vue-color</code>ä¸­çš„<code>Sketch</code>å…·ä½“å»npmæŸ¥çœ‹ã€‚è·å–rgbaã€‚è®¾ç½®æ§ä»¶çš„<code>fill</code>æ ·å¼å³å¯ã€‚</p></blockquote><h4 id="å­—ä½“æ ·å¼"><a href="#å­—ä½“æ ·å¼" class="headerlink" title="å­—ä½“æ ·å¼"></a>å­—ä½“æ ·å¼</h4><ul><li>ç²—ä½“ - è®¾ç½®å±æ€§<code>fontWeight</code>ä¸º<code>blob</code>æˆ–è€…<code>normal</code></li><li>æ–œä½“ - è®¾ç½®å±æ€§<code>fontStyle</code>ä¸º<code>italic</code>æˆ–è€…<code>normal</code></li><li>ä¸‹åˆ’çº¿ - è®¾ç½®å±æ€§<code>underline</code>ä¸º<code>true</code>æˆ–è€…<code>false</code></li><li>åˆ é™¤çº¿ - è®¾ç½®å±æ€§<code>linethrough</code>ä¸º<code>true</code>æˆ–è€…<code>false</code></li><li>ä¸Šåˆ’çº¿ - è®¾ç½®å±æ€§<code>overline</code>ä¸º<code>true</code>æˆ–è€…<code>false</code><h4 id="è¡Œé«˜"><a href="#è¡Œé«˜" class="headerlink" title="è¡Œé«˜"></a>è¡Œé«˜</h4><blockquote><p>è®¾ç½®æ§ä»¶å±æ€§ï¼š<code>lineHeight</code></p></blockquote><h3 id="å±‚çº§ç§»åŠ¨"><a href="#å±‚çº§ç§»åŠ¨" class="headerlink" title="å±‚çº§ç§»åŠ¨"></a>å±‚çº§ç§»åŠ¨</h3><h4 id="ä¸Šç§»"><a href="#ä¸Šç§»" class="headerlink" title="ä¸Šç§»"></a>ä¸Šç§»</h4><blockquote><p>è·å–å½“å‰é€‰æ‹©æ§ä»¶è°ƒç”¨æ§ä»¶<code>bringToFront</code>å‡½æ•°</p></blockquote><h4 id="ä¸‹ç§»"><a href="#ä¸‹ç§»" class="headerlink" title="ä¸‹ç§»"></a>ä¸‹ç§»</h4><blockquote><p>è·å–å½“å‰é€‰æ‹©æ§ä»¶è°ƒç”¨æ§ä»¶<code>sendToBack</code>å‡½æ•°</p></blockquote><h3 id="èƒŒæ™¯å›¾ç‰‡"><a href="#èƒŒæ™¯å›¾ç‰‡" class="headerlink" title="èƒŒæ™¯å›¾ç‰‡"></a>èƒŒæ™¯å›¾ç‰‡</h3><blockquote><p>ä¸æ·»åŠ å›¾ç‰‡ä¸€æ ·å¯ä»¥ä»å¤šç§æ•°æ®æºæ·»åŠ ã€‚</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">setBackgroundImage (img, opt = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; _radius, _resizeMode, _opacity &#125; = opt;</span><br><span class="line">    <span class="comment">// è·å–å›¾ç‰‡æœ€å¤§çš„åŠå¾„</span></span><br><span class="line">    <span class="keyword">this</span>.backgroundImageRadiusMax = <span class="keyword">this</span>.imageMaxRange(img);</span><br><span class="line">    <span class="comment">// è®¾ç½®å›¾ç‰‡å½“å‰åœ†è§’åŠå¾„</span></span><br><span class="line">    <span class="keyword">this</span>.backgroundImageRadius = _radius || <span class="keyword">this</span>.backgroundImageRadiusMax;</span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰å›¾ç‰‡å¡«å……æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">this</span>.backgroundImageResizeMode = _resizeMode || <span class="keyword">this</span>.backgroundImageResizeMode;</span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰ç”»å¸ƒå¤§å°é€‚é…å›¾ç‰‡æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">const</span> &#123; width, height &#125; = <span class="keyword">this</span>.canvas;</span><br><span class="line">    <span class="keyword">const</span> scaleX = width / img.width;</span><br><span class="line">    <span class="keyword">const</span> scaleY = height / img.height;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.backgroundImageResizeMode === ResizeMode.stretch) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸Šæ‹‰ä¼¸å¡«å……åˆ™ä¸ä¿æŒç™¾åˆ†æ¯”ç›´æ¥æŒ‰ç”»å¸ƒæ¯”ä¾‹ç¼©æ”¾</span></span><br><span class="line">        img.set(&#123; scaleX, scaleY, <span class="attr">left</span>: <span class="number">0</span>, <span class="attr">top</span>: <span class="number">0</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä»¥è¦†ç›–æ•´ä¸ªç”»å¸ƒå¡«å……åˆ™æŒ‰ç…§æœ€å¤§çš„ç”»å¸ƒæ¯”ä¾‹ç¼©æ”¾å›¾ç‰‡å®½é«˜ï¼Œåä¹‹ä¸ºç”»å¸ƒçš„æœ€å°æ¯”ä¾‹ç¼©æ”¾ã€‚</span></span><br><span class="line">        <span class="keyword">const</span> isCover = <span class="keyword">this</span>.backgroundImageResizeMode === ResizeMode.cover;</span><br><span class="line">        <span class="keyword">const</span> scale = isCover ? <span class="built_in">Math</span>.max(scaleX, scaleY) : <span class="built_in">Math</span>.min(scaleX, scaleY);</span><br><span class="line">        img.scale(scale).set(&#123;</span><br><span class="line">            left: width / <span class="number">2</span> - img.width * scale / <span class="number">2</span>,</span><br><span class="line">            top: height / <span class="number">2</span> - img.height * scale / <span class="number">2</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.canvas.setBackgroundImage(img, <span class="keyword">this</span>.canvas.renderAll.bind(<span class="keyword">this</span>.canvas), &#123;</span><br><span class="line">        originX: <span class="string">'left'</span>,</span><br><span class="line">        originY: <span class="string">'top'</span>,</span><br><span class="line">        opacity: _opacity || <span class="number">1</span>,</span><br><span class="line">        clipTo: <span class="function"><span class="params">ctx</span> =&gt;</span> ctx.arc(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.backgroundImageRadius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.currentBackgroundImg = img;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li></ul><h3 id="èƒŒæ™¯é¢œè‰²"><a href="#èƒŒæ™¯é¢œè‰²" class="headerlink" title="èƒŒæ™¯é¢œè‰²"></a>èƒŒæ™¯é¢œè‰²</h3><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.canvas.setBackgroundColor(<span class="keyword">this</span>.rgba, <span class="keyword">this</span>.canvas.renderAll.bind(<span class="keyword">this</span>.canvas));</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h3><blockquote><p>è·å–å½“å‰æ§ä»¶ï¼Œä»ç”»å¸ƒä¸­åˆ é™¤<br><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">removeActive () &#123;</span><br><span class="line">    <span class="keyword">const</span> active = <span class="keyword">this</span>.canvas.getActiveObject();</span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">        <span class="keyword">this</span>.remove(active);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> objects = <span class="keyword">this</span>.canvas.getActiveObjects();</span><br><span class="line">        <span class="keyword">this</span>.canvas.discardActiveObject(<span class="literal">null</span>);</span><br><span class="line">        objects.forEach(<span class="function"><span class="params">object</span> =&gt;</span> <span class="keyword">this</span>.remove(object));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">remove (obj) &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj &amp;&amp; obj._remove !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.canvas.remove(obj);</span><br><span class="line">        <span class="built_in">Reflect</span>.deleteProperty(<span class="keyword">this</span>.radius, obj.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="ä¿å­˜-amp-å¯¼å‡º"><a href="#ä¿å­˜-amp-å¯¼å‡º" class="headerlink" title="ä¿å­˜&amp;å¯¼å‡º"></a>ä¿å­˜&amp;å¯¼å‡º</h3><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> save () &#123;</span><br><span class="line">    <span class="keyword">const</span> before = <span class="keyword">await</span> <span class="keyword">this</span>.beforeSave(<span class="keyword">this</span>.canvas.getObjects().lenght, <span class="keyword">this</span>.canvas.backgroundImage, <span class="keyword">this</span>.canvas.backgroundColor);</span><br><span class="line">    <span class="keyword">if</span> (before === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!fabric.Canvas.supports(<span class="string">'toDataURL'</span>)) &#123;</span><br><span class="line">        alert(<span class="string">'This browser doesn\'t provide means to serialize canvas to an image'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> json = <span class="keyword">this</span>.canvas.toJSON([<span class="string">'id'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (json.backgroundImage) &#123;</span><br><span class="line">            json.backgroundImage._radius = <span class="keyword">this</span>.backgroundImageRadius;</span><br><span class="line">            json.backgroundImage._resizeMode = <span class="keyword">this</span>.backgroundImageResizeMode;</span><br><span class="line">            json.backgroundImage._opacity = <span class="keyword">this</span>.backgroundImageOpacity;</span><br><span class="line">        &#125;</span><br><span class="line">        json.objects.filter(<span class="function"><span class="params">o</span> =&gt;</span> o.type === <span class="string">'image'</span> &amp;&amp; <span class="built_in">Reflect</span>.has(<span class="keyword">this</span>.radius, o.id)).forEach(<span class="function"><span class="params">o</span> =&gt;</span> &#123;</span><br><span class="line">            o._radius = <span class="keyword">this</span>.radius[o.id].val;</span><br><span class="line">            <span class="built_in">Reflect</span>.deleteProperty(o, <span class="string">'id'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.onSave(json, <span class="keyword">this</span>.canvas.toDataURL(<span class="string">'png'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ è½½æ•°æ®"><a href="#åŠ è½½æ•°æ®" class="headerlink" title="åŠ è½½æ•°æ®"></a>åŠ è½½æ•°æ®</h3><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> loadJSON (val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (val) &#123;</span><br><span class="line">        <span class="keyword">const</span> json = <span class="keyword">typeof</span> val === <span class="string">'string'</span> ? <span class="built_in">JSON</span>.parse(val) : val;</span><br><span class="line">        <span class="keyword">if</span> (json.background) &#123;</span><br><span class="line">            <span class="keyword">this</span>.canvas.setBackgroundColor(json.background, <span class="keyword">this</span>.canvas.renderAll.bind(<span class="keyword">this</span>.canvas));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json.backgroundImage) &#123;</span><br><span class="line">            <span class="keyword">const</span> img = <span class="keyword">await</span> <span class="keyword">this</span>.loadImg(json.backgroundImage.src, json.backgroundImage);</span><br><span class="line">            <span class="keyword">this</span>.setBackgroundImage(img, json.backgroundImage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(json.objects)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">this</span>.loadData(json.objects);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.canvas.requestRenderAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="keyword">async</span> loadData (data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        data = <span class="built_in">Array</span>.isArray(data) ? data : <span class="built_in">Array</span>.of(data);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> obj <span class="keyword">of</span> data) &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj.type === <span class="string">'image'</span>) &#123;</span><br><span class="line">                <span class="built_in">Reflect</span>.deleteProperty(obj, <span class="string">'clipTo'</span>);</span><br><span class="line">                <span class="keyword">await</span> <span class="keyword">this</span>.addImg(obj.src, obj);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (obj.type === <span class="string">'i-text'</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="keyword">this</span>.addText(obj.text, obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å“ï¼Œæœ¬äººæ‡’äººç—…å‘äº†ï¼Œåé¢çš„ç›´æ¥è´´ä»£ç äº†ï¼Œå¦‚æœ‰ä¸æ˜ä¹‹å¤„æˆ–é”™è¯¯åœ°æ–¹å¯ä»¥åœ¨å½“å‰é¡µé¢è¯„è®ºäº¤æµï¼Œæˆ–<a href="https://github.com/zhouxianjun/muse-ui-fabric/issues" target="_blank" rel="noopener">Github issue</a>ã€‚<br>ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿ï¼Œå·²ä¸Šä¼ <code>npm</code> <a href="https://www.npmjs.com/package/muse-ui-fabric" target="_blank" rel="noopener">muse-ui-fabric</a></p></blockquote><iframe id="cp_embed_JeEboJ" src="//codepen.io/zhouxianjun/embed/JeEboJ?height=600&theme-id=0&slug-hash=JeEboJ&default-tab=[js,result]&embed-version=2" scrolling="no" frameborder="no" height="600" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe" style="width: 100%; overflow: hidden;"></iframe>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> fabric </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fabric </tag>
            
            <tag> poster </tag>
            
            <tag> muse ui </tag>
            
            <tag> æµ·æŠ¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisson åˆ†å¸ƒå¼é”</title>
      <link href="/2019/04/29/redisson-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
      <url>/2019/04/29/redisson-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œéœ€è¦å¾ˆå¤šçš„æŠ€æœ¯æ–¹æ¡ˆæ¥æ”¯æŒï¼Œæ¯”å¦‚åˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†å¸ƒå¼é”ç­‰ã€‚æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ä¸€ä¸ªæ–¹æ³•åœ¨åŒä¸€æ—¶é—´å†…åªèƒ½è¢«åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚åœ¨å•æœºç¯å¢ƒä¸­ï¼ŒJavaä¸­å…¶å®æä¾›äº†å¾ˆå¤šå¹¶å‘å¤„ç†ç›¸å…³çš„APIï¼Œä¾‹å¦‚ï¼š<code>ReentrantLock</code>ä¸<code>synchronized</code>ç­‰ï¼Œ<br>ä½†æ˜¯è¿™äº›APIåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸­å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚ä¹Ÿå°±æ˜¯è¯´å•çº¯çš„Java APIå¹¶ä¸èƒ½æä¾›åˆ†å¸ƒå¼é”çš„èƒ½åŠ›ã€‚æ‰€ä»¥é’ˆå¯¹åˆ†å¸ƒå¼é”çš„å®ç°ç›®å‰æœ‰å¤šç§æ–¹æ¡ˆã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä¸»è¦è¯´ä½¿ç”¨Redisson(Rediså¼€æºæ¡†æ¶)<a href="https://github.com/redisson/redisson/wiki/8.-åˆ†å¸ƒå¼é”å’ŒåŒæ­¥å™¨" target="_blank" rel="noopener">åˆ†å¸ƒå¼é”å’ŒåŒæ­¥å™¨</a>åšåˆ†å¸ƒå¼é”ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨Redisæ“ä½œï¼Œä¾‹å¦‚luaè„šæœ¬ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚</p><h3 id="å•é”"><a href="#å•é”" class="headerlink" title="å•é”"></a>å•é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¸ªé”</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> times ç­‰å¾…æ—¶é•¿(æ¯«ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keys key å¤šä¸ªkeyè‡ªåŠ¨ä»¥å†’å·è¿æ¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> TimeoutException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RLock <span class="title">lock</span><span class="params">(<span class="keyword">long</span> times, String ...keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºredisé»˜è®¤ä»¥å†’å·ä½œä¸ºç›®å½•åˆ†éš”ï¼ˆredisæ²¡æœ‰ç›®å½•è¿™ä¸€è¯´ï¼‰</span></span><br><span class="line">    String key = String.join(<span class="string">":"</span>, keys);</span><br><span class="line">    RLock rLock = redissonClient.getFairLock(key);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®é”ä½æ—¶é—´ä¸ºç­‰å¾…æ—¶é—´çš„2å€</span></span><br><span class="line">        <span class="keyword">boolean</span> res = rLock.tryLock(times, times * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">        log.warn(<span class="string">"åˆ†å¸ƒå¼é”:&#123;&#125; è¶…æ—¶"</span>, key, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rLock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è”é”"><a href="#è”é”" class="headerlink" title="è”é”"></a>è”é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RedissonMultiLock <span class="title">lock</span><span class="params">(<span class="keyword">long</span> times, Set&lt;String&gt; keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">    RLock[] locks = keys.stream().map(key -&gt; redissonClient.getFairLock(key)).toArray(RLock[]::<span class="keyword">new</span>);</span><br><span class="line">    RedissonMultiLock lock = <span class="keyword">new</span> RedissonMultiLock(locks);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> res = lock.tryLock(times, times * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">        log.warn(<span class="string">"åˆ†å¸ƒå¼è”é”:&#123;&#125; è¶…æ—¶"</span>, keys, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alone.common.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.RedissonMultiLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhouxianjun(Alone)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/10/14 10:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TIMES = <span class="number">1000</span> * <span class="number">30</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> times ç­‰å¾…æ—¶é•¿(æ¯«ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keys key å¤šä¸ªkeyè‡ªåŠ¨ä»¥å†’å·è¿æ¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> TimeoutException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RLock <span class="title">lock</span><span class="params">(<span class="keyword">long</span> times, String ...keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        String key = String.join(<span class="string">":"</span>, keys);</span><br><span class="line">        RLock rLock = redissonClient.getFairLock(key);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> res = rLock.tryLock(times, times * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">            log.warn(<span class="string">"åˆ†å¸ƒå¼é”:&#123;&#125; è¶…æ—¶"</span>, key, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RLock <span class="title">lock</span><span class="params">(String ...keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(TIMES, keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonMultiLock <span class="title">lockAutoJoin</span><span class="params">(<span class="keyword">long</span> times, Set&lt;String[]&gt; keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        Set&lt;String&gt; kSet = keys.stream().map(strings -&gt; String.join(<span class="string">":"</span>, strings)).collect(Collectors.toSet());</span><br><span class="line">        <span class="keyword">return</span> lock(times, kSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonMultiLock <span class="title">lock</span><span class="params">(<span class="keyword">long</span> times, Set&lt;String&gt; keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        RLock[] locks = keys.stream().map(key -&gt; redissonClient.getFairLock(key)).toArray(RLock[]::<span class="keyword">new</span>);</span><br><span class="line">        RedissonMultiLock lock = <span class="keyword">new</span> RedissonMultiLock(locks);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> res = lock.tryLock(times, times * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">            log.warn(<span class="string">"åˆ†å¸ƒå¼è”é”:&#123;&#125; è¶…æ—¶"</span>, keys, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonMultiLock <span class="title">lockAutoJoin</span><span class="params">(Set&lt;String[]&gt; keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lockAutoJoin(TIMES, keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonMultiLock <span class="title">lock</span><span class="params">(Set&lt;String&gt; keys)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lock(TIMES, keys);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ç®¡é”åˆ†å¸ƒå¼é”è¿˜æ˜¯Java APIçš„å„ç§é”ï¼Œåªè¦ç”¨äº†é”åˆ™ä¼šæŸè€—ä¸€å®šçš„æ€§èƒ½ä½œä¸ºä»£ä»·ï¼Œæ‰€ä»¥è¦åœ¨éœ€è¦çš„åœ°æ–¹ä½¿ç”¨ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redisson </tag>
            
            <tag> redis </tag>
            
            <tag> lock </tag>
            
            <tag> distributed </tag>
            
            <tag> åˆ†å¸ƒå¼é” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iView Table è¡¨æ ¼åˆå¹¶</title>
      <link href="/2019/04/28/iView-Table-%E8%A1%A8%E6%A0%BC%E5%90%88%E5%B9%B6/"/>
      <url>/2019/04/28/iView-Table-%E8%A1%A8%E6%A0%BC%E5%90%88%E5%B9%B6/</url>
      
        <content type="html"><![CDATA[<p>åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œæ€»æ˜¯æœ‰äº›åœ°æ–¹éœ€è¦æŠŠå•å…ƒæ ¼åˆå¹¶çš„ï¼Œæ¯”å¦‚è®¢å•åˆ—è¡¨ï¼šåŒä¸€ä¸ªè®¢å•å·ï¼Œä¸åŒçš„äº§å“ï¼Œåˆ™éœ€è¦åˆå¹¶è®¢å•å·ç­‰ã€‚<br>ä½†æ˜¯å®˜æ–¹ç›®å‰åªæ”¯æŒè¡¨å¤´çš„åˆå¹¶ï¼Œè¿˜æœªæ”¯æŒå•å…ƒæ ¼çš„åˆå¹¶ï¼Œæœ‰äººåœ¨Githubä¸Šæäº†<a href="https://github.com/iview/iview/issues/2751" target="_blank" rel="noopener">Issues</a>,<br>ä½†æ˜¯å®˜æ–¹ä¸€ç›´æ²¡æœ‰è§£å†³ï¼Œsoã€‚ã€‚ã€‚æˆ‘å°±è‡ªå·±å†™äº†ï¼Œä¸€ä¸ªæ–¹æ³•ï¼Œæ€è·¯æ˜¯ï¼š</p><ol><li>è·å–åˆ°Vueä¸­iViewåˆ°Tableå®ä¾‹ï¼›</li><li><p>è·å–å½“å‰æ‰€æœ‰è¡Œæ•°æ®ï¼ˆclassä¸º<code>ivu-table-row</code>ï¼‰;</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rows = table?.$refs?.tbody?.$el?.getElementsByClassName(<span class="string">'ivu-table-row'</span>);</span><br></pre></td></tr></table></figure></li><li><p>å¾ªç¯æ¯æ¡æ•°æ®ï¼Œåˆ¤æ–­å½“å‰è¡Œæ•°æ®çš„ç›¸é‚»æ•°æ®æ˜¯å¦ç›¸ç­‰ï¼Œä¾‹å¦‚ï¼š[{id: 1}, {id: 1}]åˆ™ä»£è¡¨ç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œçš„idå€¼ä¸ºç›¸é‚»æ•°æ®ï¼Œåä¹‹ï¼š[{id: 1},{id: 2},{id: 3}]åˆ™ä¸ç®—ç›¸é‚»æ•°æ®ã€‚</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€åä¸€ä¸ªç›¸é‚»æ•°æ®çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>data æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>value å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>field å­—æ®µ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>index å½“å‰æ•°æ®ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;number&#125;</span> </span>ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> lastAdjacentIndex = <span class="function">(<span class="params">data, value, field, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> last = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å–å‡ºå¤§äºå½“å‰ä¸‹æ ‡çš„æ‰€æœ‰æ•°æ®</span></span><br><span class="line">    <span class="keyword">const</span> slice = data.slice(index);</span><br><span class="line">    <span class="comment">// å¾ªç¯æ¯ä¸ªæ•°æ®åˆ¤æ–­æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; slice.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (slice[i][field] === value) &#123;</span><br><span class="line">            last = index + i;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åªè¦æœ‰ä¸€ä¸ªä¸ç›¸ç­‰åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> last;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> last;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>æŠŠç›¸é‚»æ•°æ®çš„ä¸‹é¢æ‰€æœ‰è¡Œçš„å½“å‰åˆ—åˆ é™¤ã€‚</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// colSpanItemä¸ºå·²ç»åˆ é™¤åˆ—çš„è¡Œæ•°æ®ï¼škeyä¸ºè¡Œä¸‹æ ‡ï¼Œå€¼ä¸ºåˆ—ä¸‹æ ‡+1</span></span><br><span class="line"><span class="keyword">const</span> lastIndex = lastAdjacentIndex(data, item[field], field, index);</span><br><span class="line"><span class="keyword">const</span> rowSpan = lastIndex - index + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (rowSpan &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; rowSpan; i++) &#123;</span><br><span class="line">        rows[index + i].querySelector(<span class="string">`td:nth-of-type(<span class="subst">$&#123;colIndex + <span class="number">1</span> - (colSpanItem[index + i] || <span class="number">0</span>)&#125;</span>)`</span>).remove();</span><br><span class="line">      colSpanItem[index + i] = colIndex + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åå¯¹å½“å‰è¡Œçš„å½“å‰åˆ—è®¾ç½®rowspanå±æ€§ï¼Œæœ‰å‡ ä¸ªç›¸é‚»æ•°æ®å°±ä¸ºå‡ ã€‚</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rows[index].querySelector(<span class="string">`td:nth-of-type(<span class="subst">$&#123;colIndex + <span class="number">1</span> - (colSpanItem[index] || <span class="number">0</span>)&#125;</span>)`</span>).setAttribute(<span class="string">'rowspan'</span>, rowSpan);</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>ä¸ºäº†å¤§å®¶ä½¿ç”¨æ–¹ä¾¿ï¼Œæˆ‘å·²ç»æ‰“åŒ…åˆ°<code>npm</code>ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨: <a href="https://www.npmjs.com/package/ivu-table-merge" target="_blank" rel="noopener">ivu-table-merge</a></p></blockquote><p>å…·ä½“è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><iframe id="cp_embed_pBqmVm" src="//codepen.io/zhouxianjun/embed/pBqmVm?height=330&theme-id=0&slug-hash=pBqmVm&default-tab=[js,result]&embed-version=2" scrolling="no" frameborder="no" height="330" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe" style="width: 100%; overflow: hidden;"></iframe>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> iView </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iView </tag>
            
            <tag> table </tag>
            
            <tag> merge </tag>
            
            <tag> åˆå¹¶å•å…ƒæ ¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fabricjs ç”»å…­è¾¹å½¢</title>
      <link href="/2019/04/26/Fabricjs-%E7%94%BB%E5%85%AD%E8%BE%B9%E5%BD%A2/"/>
      <url>/2019/04/26/Fabricjs-%E7%94%BB%E5%85%AD%E8%BE%B9%E5%BD%A2/</url>
      
        <content type="html"><![CDATA[<p>fabricjsï¼Œå°±æ˜¯ä¸€ä¸ªå‰ç«¯ç”»æ¿ï¼Œcanvasçš„å¢å¼ºç‰ˆã€‚</p><p>ä½¿ç”¨fabricjsæ¥ç”»å…­è¾¹å½¢å’Œcanvasç”»å…¶å®åŸç†æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ–¹æ³•ä¸åŒã€‚</p><ol><li>è®¾å®šå˜é‡ï¼š <ul><li><code>start</code> é¼ æ ‡æŒ‰ä¸‹ï¼Œå¼€å§‹çš„äº‹ä»¶å¯¹è±¡</li><li><code>upObj</code> åœ¨é¼ æ ‡æ²¡æœ‰æ¾å¼€çš„æƒ…å†µä¸‹ä¸Šä¸€æ¬¡ç»˜ç”»çš„å¯¹è±¡</li></ul></li><li><p>ç»‘å®šç”»æ¿äº‹ä»¶<code>mouse:down</code>è®¾ç½®å¼€å§‹äº‹ä»¶</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.on(<span class="string">"mouse:down"</span>, o =&gt; (start = o.e));</span><br></pre></td></tr></table></figure></li><li><p>ç»‘å®šç”»æ¿äº‹ä»¶<code>mouse:up</code>ç»˜ç”»ç»“æŸï¼Œæ¸…ç©ºå¼€å§‹äº‹ä»¶å¯¹è±¡ï¼Œå¹¶æ¸…ç©ºä¸Šä¸€æ¬¡ç»˜ç”»å¯¹è±¡</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">canvas.on(<span class="string">"mouse:up"</span>, o =&gt; &#123;</span><br><span class="line">  start = <span class="literal">null</span>;</span><br><span class="line">  upObj = <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>ç»‘å®šç”»æ¿äº‹ä»¶<code>mouse:move</code>ç»˜ç”»ï¼Œä¹Ÿå¯ä»¥åœ¨<code>mouse:up</code>æ—¶ç»˜ç”»ï¼Œä½†è¿™æ ·ä½“éªŒæ•ˆæœä¸å¥½</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">canvas.on(<span class="string">"mouse:move"</span>, o =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!start) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (upObj) &#123;</span><br><span class="line">    canvas.remove(upObj);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">offsetX</span>: sx, <span class="attr">offsetY</span>: sy &#125; = start;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">e</span>: &#123; <span class="attr">offsetX</span>: ex, <span class="attr">offsetY</span>: ey &#125; &#125; = o;</span><br><span class="line">  <span class="comment">// è®¡ç®—åŠå¾„ï¼Œè¾¹é•¿</span></span><br><span class="line">  <span class="keyword">const</span> R = <span class="built_in">Math</span>.sqrt((ex - sx) * (ex - sx) + (ey - sy) * (ey - sy)) / <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 6æ¡è¾¹çš„åæ ‡ç‚¹ï¼ˆ60æ˜¯å…­è¾¹å½¢çš„å†…è§’åº¦æ•°ï¼‰</span></span><br><span class="line">  <span class="keyword">const</span> points = <span class="built_in">Array</span>.from(&#123; <span class="attr">length</span>: <span class="number">6</span> &#125;).map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      x: <span class="built_in">Math</span>.cos(<span class="number">60</span> * index / <span class="number">180</span> * <span class="built_in">Math</span>.PI) * R,</span><br><span class="line">      y: <span class="built_in">Math</span>.sin(<span class="number">60</span> * index / <span class="number">180</span> * <span class="built_in">Math</span>.PI) * R</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">  upObj = <span class="keyword">new</span> fabric.Polygon(points, &#123;</span><br><span class="line">    top: sy,</span><br><span class="line">    left: sx,</span><br><span class="line">    stroke: <span class="string">"red"</span>,</span><br><span class="line">    fill: <span class="string">"rgba(255,255,255,0)"</span></span><br><span class="line">  &#125;);</span><br><span class="line">  canvas.add(upObj);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ol><iframe id="cp_embed_VNqqEL" src="//codepen.io/zhouxianjun/embed/VNqqEL?height=600&theme-id=0&slug-hash=VNqqEL&default-tab=[js,result]&embed-version=2" scrolling="no" frameborder="no" height="600" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe" style="width: 800px; overflow: hidden;"></iframe>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> fabric </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fabric </tag>
            
            <tag> js </tag>
            
            <tag> å…­è¾¹å½¢ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
